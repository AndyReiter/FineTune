<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Work Orders MVP</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f7f8;
      margin: 0;
      padding: 20px;
    }

    h1, h2, h3 {
      margin-bottom: 10px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    form {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    input, select, button {
      padding: 8px;
      font-size: 14px;
    }

    button {
      cursor: pointer;
    }

    .full-width {
      grid-column: span 5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
      vertical-align: top;
    }

    th {
      background: #f0f0f0;
    }

    ul {
      margin: 0;
      padding-left: 18px;
    }

    .actions button {
      margin-right: 5px;
    }

    .message {
      margin-top: 10px;
      font-size: 14px;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      min-width: 80px;
    }

    .status-PENDING {
      background: #fff3cd;
      color: #856404;
    }

    .status-IN_PROGRESS {
      background: #cce5ff;
      color: #004085;
    }

    .status-DONE {
      background: #d4edda;
      color: #155724;
    }

    .status-RECEIVED {
      background: #e7d4f5;
      color: #5a1a7f;
    }

    .status-PICKED_UP {
      background: #d1ecf1;
      color: #0c5460;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }

    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 6px;
      width: 500px;
      max-width: 90%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    .modal-header {
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }

    .modal-body {
      margin: 15px 0;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-footer button {
      padding: 8px 16px;
    }

    .ski-status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .ski-status-row:last-child {
      border-bottom: none;
    }

    .ski-info {
      flex: 1;
    }

    .ski-status-select {
      padding: 6px 12px;
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .action-buttons button {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-success {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn-success:hover {
      background: #218838;
    }

    .empty-message {
      text-align: center;
      padding: 20px;
      color: #999;
      font-style: italic;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Work Orders (MVP)</h1>

  <!-- ===============================
       Create Work Order
       =============================== -->
  <h2>Create Work Order</h2>

  <form id="createForm">
    <input type="text" id="firstName" placeholder="First Name" required />
    <input type="text" id="lastName" placeholder="Last Name" required />
    <input type="text" id="phone" placeholder="Phone (10 digits)" required />
    <input type="email" id="email" placeholder="Email" required />
    <div></div>

    <div class="full-width">
      <h3>Skis</h3>
      <table>
        <thead>
          <tr>
            <th>Make</th>
            <th>Model</th>
            <th>Service</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="skiItemsTable"></tbody>
      </table>
      <button type="button" onclick="addSkiRow()">+ Add Ski</button>
    </div>

    <button type="submit" class="full-width">Create Work Order</button>
  </form>

  <div id="formMessage" class="message"></div>

  <!-- ===============================
       Work Orders List
       =============================== -->
  <h2>All Work Orders</h2>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Customer</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Skis</th>
        <th>Work Order Status</th>
        <th>Created At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="workOrdersTable"></tbody>
  </table>

  <div id="listMessage" class="message"></div>
</div>

<!-- ===============================
     Edit Work Order Modal
     =============================== -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Edit Work Order Status</h3>
    </div>
    <div id="modalBody" class="modal-body"></div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
      <button type="button" id="pickupBtn" class="btn-success" onclick="markAsPickup()" style="display: none;">
        Ready for Pickup
      </button>
    </div>
  </div>
</div>

<script>
  const API_BASE = "http://localhost:8080/workorders";

  const tableBody = document.getElementById("workOrdersTable");
  const formMessage = document.getElementById("formMessage");
  const listMessage = document.getElementById("listMessage");
  const skiItemsTable = document.getElementById("skiItemsTable");
  const editModal = document.getElementById("editModal");
  const modalBody = document.getElementById("modalBody");
  const pickupBtn = document.getElementById("pickupBtn");

  let currentEditingOrderId = null;

  /* ===============================
     Modal Functions
     =============================== */
  function openEditModal(orderId) {
    currentEditingOrderId = orderId;
    editModal.style.display = "block";
    loadOrderForEditing(orderId);
  }

  function closeEditModal() {
    editModal.style.display = "none";
    currentEditingOrderId = null;
    modalBody.innerHTML = "";
  }

  window.onclick = function(event) {
    if (event.target === editModal) {
      closeEditModal();
    }
  };

  /* ===============================
     Load Order for Editing
     =============================== */
  async function loadOrderForEditing(orderId) {
    try {
      const response = await fetch(`${API_BASE}/${orderId}`);
      const order = await response.json();

      modalBody.innerHTML = `
        <div style="margin-bottom: 15px;">
          <strong>Customer:</strong> ${order.customerName}<br>
          <strong>Work Order Status:</strong> 
          <span class="status-badge status-${order.status}">${order.status}</span>
          ${order.status === "PICKED_UP" ? '<div style="color: #28a745; margin-top: 10px; font-weight: bold;">✓ Order has been picked up</div>' : ''}
        </div>

        <h4>Ski Items</h4>
        <div id="skiStatusItems"></div>
      `;

      const skiStatusItems = document.getElementById("skiStatusItems");

      if (!order.skiItems || order.skiItems.length === 0) {
        skiStatusItems.innerHTML = '<div class="empty-message">No skis in this work order</div>';
        pickupBtn.style.display = "none";
      } else {
        skiStatusItems.innerHTML = order.skiItems.map(ski => `
          <div class="ski-status-row">
            <div class="ski-info">
              <strong>${ski.skiMake} ${ski.skiModel}</strong> (${ski.serviceType})<br>
              <span style="font-size: 12px; color: #666;">Current status: 
                <span class="status-badge status-${ski.status}">${ski.status}</span>
              </span>
            </div>
            <select class="ski-status-select" data-ski-id="${ski.id}" onchange="updateSkiStatus(${orderId}, ${ski.id}, this.value)" ${ski.status === "PICKED_UP" ? "disabled" : ""}>
              <option value="PENDING" ${ski.status === "PENDING" ? "selected" : ""}>PENDING</option>
              <option value="IN_PROGRESS" ${ski.status === "IN_PROGRESS" ? "selected" : ""}>IN_PROGRESS</option>
              <option value="DONE" ${ski.status === "DONE" ? "selected" : ""}>DONE</option>
              <option value="PICKED_UP" ${ski.status === "PICKED_UP" ? "selected" : ""}>PICKED_UP</option>
            </select>
          </div>
        `).join("");

        // Check if all items are DONE (not picked up yet)
        const allDone = order.skiItems.every(ski => ski.status === "DONE");
        const allPickedUp = order.skiItems.every(ski => ski.status === "PICKED_UP");
        
        // Show pickup button only if all items are DONE and order not yet picked up
        pickupBtn.style.display = (allDone && !allPickedUp) ? "block" : "none";
      }
    } catch (error) {
      console.error(error);
      modalBody.innerHTML = '<div class="error">Failed to load work order.</div>';
      pickupBtn.style.display = "none";
    }
  }

  /* ===============================
     Update Ski Status
     =============================== */
  async function updateSkiStatus(orderId, skiId, newStatus) {
    try {
      const response = await fetch(`${API_BASE}/${orderId}/skis/${skiId}/status`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });

      if (!response.ok) throw new Error("Failed to update status");

      // Reload the modal to reflect changes
      loadOrderForEditing(orderId);
      // Reload the main list
      fetchWorkOrders();
    } catch (error) {
      console.error(error);
      alert("Error updating ski status: " + error.message);
    }
  }

  /* ===============================
     Mark as Pickup (Ready for Pickup)
     =============================== */
  async function markAsPickup() {
    if (!currentEditingOrderId) return;

    try {
      const response = await fetch(`${API_BASE}/${currentEditingOrderId}/pickup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      if (!response.ok) throw new Error("Failed to mark as pickup");

      alert("Work order marked as Ready for Pickup!");
      closeEditModal();
      fetchWorkOrders();
    } catch (error) {
      console.error(error);
      alert("Error marking as pickup: " + error.message);
    }
  }

  /* ===============================
     Get Status Badge HTML
     =============================== */
  function getStatusBadge(status) {
    return `<span class="status-badge status-${status}">${status}</span>`;
  }

  /* ===============================
     Ski Rows
     =============================== */
  function addSkiRow() {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>
        <!-- Ski Make dropdown populated from /brands (value = brand id, text = brand name) -->
        <select class="ski-make" required>
          <option value="">Select Make</option>
        </select>
      </td>
      <td>
        <!-- Ski Model dropdown populated from /brands/{id}/models (value/text = model name) -->
        <select class="ski-model" required>
          <option value="">Select Model</option>
        </select>
      </td>
      <td>
        <select required>
          <option value="">Select</option>
          <option value="TUNE">Tune</option>
          <option value="MOUNT">Mount</option>
          <option value="REPAIR">Repair</option>
        </select>
      </td>
      <td>
        <button type="button" onclick="this.closest('tr').remove()">✕</button>
      </td>
    `;

    skiItemsTable.appendChild(row);

    // Populate brand dropdown, then wire dependent models dropdown
    const makeSelect = row.querySelector(".ski-make");
    const modelSelect = row.querySelector(".ski-model");

    populateBrandSelect(makeSelect).then(() => {
      // When make changes, fetch models for that brand and populate
      makeSelect.addEventListener("change", async () => {
        const brandId = makeSelect.value;
        await populateModelSelect(modelSelect, brandId);
      });
    });
  }

  // ===============================
  // Brand/Model Dropdown Logic
  // ===============================
  const BRANDS_API = "http://localhost:8080/brands";
  let brandsCache = null; // cache brands to minimize network calls

  /**
   * Fetch brands once and populate a given select element.
   * Option value = brand.id, option text = brand.name
   */
  async function populateBrandSelect(selectEl) {
    try {
      if (!brandsCache) {
        const res = await fetch(BRANDS_API);
        brandsCache = await res.json();
      }
      // Reset options (preserve placeholder)
      selectEl.innerHTML = '<option value="">Select Make</option>' +
        brandsCache.map(b => `<option value="${b.id}">${b.name}</option>`).join("");
    } catch (err) {
      console.error("Failed to load brands", err);
    }
  }

  /**
   * Populate models for a selected brand id.
   * Option value/text = model.name to submit STRINGs as required.
   */
  async function populateModelSelect(selectEl, brandId) {
    try {
      if (!brandId) {
        selectEl.innerHTML = '<option value="">Select Model</option>';
        return;
      }
      const res = await fetch(`${BRANDS_API}/${brandId}/models`);
      const models = await res.json();
      selectEl.innerHTML = '<option value="">Select Model</option>' +
        models.map(m => `<option value="${m.name}">${m.name}</option>`).join("");
    } catch (err) {
      console.error("Failed to load models", err);
      selectEl.innerHTML = '<option value="">Select Model</option>';
    }
  }

  // Initialize first ski row after dropdown helpers are defined
  addSkiRow();

  /* ===============================
     Fetch Work Orders
     =============================== */
  async function fetchWorkOrders() {
    try {
      const response = await fetch(API_BASE);
      const data = await response.json();

      tableBody.innerHTML = "";

      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="empty-message">No work orders yet</td></tr>';
        return;
      }

      data.forEach(order => {
        const row = document.createElement("tr");

        // Count skis by status
        const skiItems = order.skiItems || [];
        const doneCount = skiItems.filter(ski => ski.status === "DONE").length;
        const totalCount = skiItems.length;

        const skiSummary = skiItems.length > 0 
          ? `${skiItems.map(ski => `${ski.skiMake} ${ski.skiModel} (${ski.serviceType}) <span class="status-badge status-${ski.status}">${ski.status}</span>`).join("<br>")}`
          : "No skis";

        row.innerHTML = `
          <td>${order.id}</td>
          <td>${order.customerName || ""}</td>
          <td>${order.customerPhone || ""}</td>
          <td>${order.customerEmail || ""}</td>
          <td>${skiSummary}</td>
          <td>${getStatusBadge(order.status)}<br><small>${doneCount}/${totalCount} items done</small></td>
          <td>${order.createdAt || ""}</td>
          <td class="action-buttons">
            <button type="button" class="btn-primary" onclick="openEditModal(${order.id})">Manage Status</button>
          </td>
        `;

        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error(error);
      listMessage.textContent = "Failed to load work orders.";
      listMessage.className = "message error";
    }
  }

  /* ===============================
     Create Work Order
     =============================== */
  document.getElementById("createForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const skiRows = [...skiItemsTable.children];

    if (skiRows.length === 0) {
      alert("At least one ski is required.");
      return;
    }

    const skis = skiRows.map(row => {
      const makeSelect = row.querySelector(".ski-make");
      const modelSelect = row.querySelector(".ski-model");
      const serviceSelect = row.querySelector("td:nth-child(3) select");
      return {
        // Submit STRING values (brand name via selected option text, model via value)
        skiMake: makeSelect.options[makeSelect.selectedIndex]?.text || "",
        skiModel: (modelSelect.value || "").trim(),
        serviceType: serviceSelect.value
      };
    });

    const payload = {
      customerFirstName: document.getElementById("firstName").value,
      customerLastName: document.getElementById("lastName").value,
      phone: document.getElementById("phone").value,
      email: document.getElementById("email").value,
      skis: skis
    };

    try {
      const response = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error();

      formMessage.textContent = "Work order created successfully.";
      formMessage.className = "message success";

      e.target.reset();
      skiItemsTable.innerHTML = "";
      addSkiRow();
      fetchWorkOrders();
    } catch {
      formMessage.textContent = "Error creating work order.";
      formMessage.className = "message error";
    }
  });

  fetchWorkOrders();
</script>

</body>
</html>
