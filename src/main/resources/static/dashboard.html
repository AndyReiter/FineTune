<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Dashboard - Equipment Management</title>
  <link rel="stylesheet" href="shared.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
/* Modern SaaS Dashboard Styles */
* {
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: #f8fafc;
  margin: 0;
  padding: 0;
  line-height: 1.6;
  color: #334155;
}

.dashboard-container {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

.sidebar {
  background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
  color: white;
  padding: 24px 0;
  position: fixed;
  width: 280px;
  height: 100vh;
  overflow-y: auto;
}

.sidebar-header {
  padding: 0 24px 24px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.2);
  margin-bottom: 24px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 20px;
  font-weight: 700;
  color: white;
  text-decoration: none;
}

.logo i {
  font-size: 24px;
  color: #3b82f6;
}

.nav-menu {
  list-style: none;
  padding: 0;
  margin: 0;
}

.nav-item {
  margin-bottom: 4px;
}

.nav-link {
  display: flex;
  align-items: center;
  padding: 12px 24px;
  color: #cbd5e1;
  text-decoration: none;
  transition: all 0.2s ease;
  border-right: 3px solid transparent;
}

.nav-link:hover {
  background: rgba(148, 163, 184, 0.1);
  color: white;
  border-right-color: #3b82f6;
}

.nav-link.active {
  background: rgba(59, 130, 246, 0.1);
  color: white;
  border-right-color: #3b82f6;
}

.nav-link i {
  width: 20px;
  margin-right: 12px;
  text-align: center;
}

.main-content {
  margin-left: 280px;
  padding: 32px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  background: white;
  padding: 20px 24px;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.page-title {
  margin: 0;
  font-size: 28px;
  font-weight: 700;
  color: #1e293b;
}

.user-section {
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-info-text {
  text-align: right;
}

.user-name {
  font-weight: 600;
  color: #334155;
}

.user-role {
  font-size: 14px;
  color: #64748b;
}

.modern-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid #e2e8f0;
  overflow: hidden;
  margin-bottom: 24px;
}

.card-header {
  padding: 24px;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
}

.card-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: #1e293b;
}

.card-content {
  padding: 24px;
}

.status-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  background: #f1f5f9;
  padding: 8px;
  border-radius: 12px;
  flex-wrap: wrap;
}

.tab-button {
  flex: 1 1 auto;
  min-width: 100px;
  padding: 10px 12px;
  border: none;
  background: transparent;
  border-radius: 8px;
  font-weight: 500;
  color: #64748b;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 13px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  white-space: nowrap;
}

.tab-button:hover {
  background: rgba(59, 130, 246, 0.1);
  color: #3b82f6;
}

.tab-button.active {
  background: #3b82f6;
  color: white;
  box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
}

.primary-button {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

.primary-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.secondary-button {
  background: white;
  color: #64748b;
  border: 2px solid #e2e8f0;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.secondary-button:hover {
  border-color: #cbd5e1;
  color: #475569;
  background: #f8fafc;
}

.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.modern-table th {
  background: #f8fafc;
  color: #475569;
  font-weight: 600;
  padding: 16px;
  text-align: left;
  border-bottom: 2px solid #e2e8f0;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.modern-table td {
  padding: 16px;
  border-bottom: 1px solid #e2e8f0;
  vertical-align: middle;
}

.modern-table tr:hover {
  background: #f8fafc;
}

.modern-table tr:last-child td {
  border-bottom: none;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  gap: 6px;
}

.badge-received { background: #fef3c7; color: #92400e; }
.badge-in-progress { background: #dbeafe; color: #1d4ed8; }
.badge-ready { background: #d1fae5; color: #065f46; }
.badge-awaiting { background: #e0e7ff; color: #3730a3; }
.badge-completed { background: #dcfce7; color: #166534; }

.action-buttons {
  display: flex;
  gap: 8px;
}

.action-btn {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-edit {
  background: #3b82f6;
  color: white;
}

.btn-edit:hover {
  background: #2563eb;
  transform: translateY(-1px);
}

.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  margin: 0;
}

.login-card {
  background: white;
  padding: 48px;
  border-radius: 16px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  width: 100%;
  max-width: 400px;
}

.login-header {
  text-align: center;
  margin-bottom: 32px;
}

.login-title {
  font-size: 24px;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 8px;
}

.login-subtitle {
  color: #64748b;
  font-size: 16px;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #374151;
}

.form-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.2s ease;
}

.form-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.login-button {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.login-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: #64748b;
}

.empty-state i {
  font-size: 48px;
  color: #cbd5e1;
  margin-bottom: 16px;
}

.empty-state h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #475569;
}

/* Original equipment styles with modern touches */
.equipment-item-row {
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  background: white;
  position: relative;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease;
}

.equipment-item-row:hover {
  border-color: #cbd5e1;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.equipment-item-row h5 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #1e293b;
  font-weight: 600;
}

.remove-equipment-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.remove-equipment-btn:hover {
  background: #dc2626;
  transform: scale(1.1);
}

/* Modern Form Styling */
.modal-body input,
.modal-body select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s ease;
}

.modal-body input:focus,
.modal-body select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal-body label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 6px;
  display: block;
}

.search-result-item {
  padding: 16px;
  border-bottom: 1px solid #e2e8f0;
  cursor: pointer;
  transition: all 0.2s ease;
  border-radius: 8px;
  margin-bottom: 4px;
}

.search-result-item:hover {
  background: #f1f5f9;
  border-color: #cbd5e1;
}

/* Enhanced Status Styling */
.ski-status-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid #e2e8f0;
  background: white;
  border-radius: 8px;
  margin-bottom: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.ski-status-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.ski-info {
  flex: 1;
}

.ski-status-select {
  padding: 8px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.ski-status-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.equipment-item-row {
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  background: white;
  position: relative;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease;
}

.equipment-item-row:hover {
  border-color: #cbd5e1;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.equipment-item-row h5 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #333;
}

.remove-equipment-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.remove-equipment-btn:hover {
  background: #dc2626;
  transform: scale(1.1);
}

.basic-equipment-fields {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 10px;
  margin-bottom: 15px;
}

.mount-fields {
  display: none;
  border-top: 2px solid #007bff;
  padding-top: 15px;
  margin-top: 15px;
}

.mount-fields.show {
  display: block;
}

.mount-fields h6 {
  color: #007bff;
  margin-bottom: 10px;
  font-size: 14px;
}

.mount-field-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}

.mount-field-row.single {
  grid-template-columns: 1fr;
}

.height-fields {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 5px;
}

.height-fields label {
  font-size: 11px;
  color: #666;
  margin-bottom: 2px;
  display: block;
}

.equipment-item-row input, 
.equipment-item-row select {
  padding: 6px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
}

.equipment-item-row input:focus, 
.equipment-item-row select:focus {
  outline: none;
  border-color: #007bff;
}

.equipment-item-row label {
  font-size: 12px;
  color: #555;
  margin-bottom: 3px;
  display: block;
}

/* Boot Modal Specific Styles */
#bootModal .modal-content {
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
}

#bootItemsContainer .equipment-item-row {
  margin-bottom: 30px;
}

#bootItemsContainer .equipment-item-row h5 {
  background: #007bff;
  color: white;
  padding: 10px 15px;
  margin: -15px -15px 15px -15px;
  border-radius: 8px 8px 0 0;
}

#existingBootOptions label {
  transition: background-color 0.2s ease;
}

#existingBootOptions label:hover {
  background-color: #f8f9fa;
}

#existingBootOptions input[type="radio"]:checked + strong {
  color: #007bff;
}

#existingBootOptions input[type="radio"]:checked {
  accent-color: #007bff;
}

.boot-choice-section {
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}

/* Customer Search Tab Styles */
.tab-button {
  padding: 10px 20px;
  border: none;
  background: #f5f5f5;
  color: #333;
  cursor: pointer;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.tab-button:hover {
  background: #e0e0e0;
}

.tab-button.active {
  background: #007bff;
  color: white;
}

.search-result-item {
  padding: 15px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.search-result-item:hover {
  background: #f8f9fa;
}

.search-result-item:last-child {
  border-bottom: none;
}

.wizard-step {
  min-height: 300px;
}
  </style>
</head>
<body>

<div id="loginSection" class="login-container">
  <div class="login-card">
    <div class="login-header">
      <h1 class="login-title">Staff Dashboard</h1>
      <p class="login-subtitle">Sign in to access the equipment management system</p>
    </div>
    <form id="loginForm">
      <div class="form-group">
        <label class="form-label" for="loginEmail">Email Address</label>
        <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="loginPassword">Password</label>
        <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
      </div>
      <button type="button" class="login-button" onclick="handleLogin()">
        <i class="fas fa-sign-in-alt"></i> Sign In
      </button>
    </form>
    <div id="loginMessage" class="message"></div>
  </div>
</div>

<div id="authenticatedSection" class="dashboard-container" style="display: none;">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="#" class="logo">
        <i class="fas fa-tools"></i>
        FineTune
      </a>
    </div>
    <nav>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link active">
            <i class="fas fa-tachometer-alt"></i>
            Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-clipboard-list"></i>
            Work Orders
          </a>
        </li>
        <li class="nav-item">
          <a href="customers.html" class="nav-link">
            <i class="fas fa-users"></i>
            Customers
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-skiing"></i>
            Equipment
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-chart-bar"></i>
            Analytics
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-cog"></i>
            Settings
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="top-bar">
      <h1 class="page-title">Work Orders Dashboard</h1>
      <div class="user-section">
        <div class="user-info-text">
          <div class="user-name">Welcome, <span id="userEmail"></span></div>
          <div class="user-role">Staff Member</div>
        </div>
        <button type="button" class="secondary-button" onclick="handleLogout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <!-- Work Orders Management Card -->
    <div id="workOrdersSection" class="modern-card">
      <div class="card-header">
        <div class="card-title">
          <span><i class="fas fa-clipboard-list"></i> Work Orders Management</span>
          <button type="button" class="primary-button" onclick="openCreateModal()">
            <i class="fas fa-plus"></i> Create New Work Order
          </button>
        </div>
      </div>
      
      <div class="card-content">
        <!-- Status Tabs -->
        <div class="status-tabs">
          <button class="tab-button active" data-status="RECEIVED" onclick="switchTab('RECEIVED', this)">
            <i class="fas fa-inbox"></i> Awaiting
          </button>
          <button class="tab-button" data-service-type="TUNE" onclick="switchTab('TUNE', this)">
            <i class="fas fa-adjust"></i> Tune
          </button>
          <button class="tab-button" data-service-type="MOUNT" onclick="switchTab('MOUNT', this)">
            <i class="fas fa-wrench"></i> Mount
          </button>
          <button class="tab-button" data-service-type="REPAIR" onclick="switchTab('REPAIR', this)">
            <i class="fas fa-tools"></i> Repair
          </button>
          <button class="tab-button" data-status="READY_FOR_PICKUP" onclick="switchTab('READY_FOR_PICKUP', this)">
            <i class="fas fa-check-circle"></i> Ready
          </button>
          <button class="tab-button" data-status="AWAITING_PICKUP" onclick="switchTab('AWAITING_PICKUP', this)">
            <i class="fas fa-clock"></i> Awaiting Pickup
          </button>
          <button class="tab-button" data-status="COMPLETED" onclick="switchTab('COMPLETED', this)">
            <i class="fas fa-check-double"></i> Completed
          </button>
        </div>

        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
          <button type="button" class="secondary-button" onclick="refreshCurrentTab()">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>

        <!-- Work Orders Table -->
        <table class="modern-table">
          <thead>
            <tr>
              <th><i class="fas fa-hashtag"></i> ID</th>
              <th><i class="fas fa-user"></i> Customer</th>
              <th><i class="fas fa-phone"></i> Phone</th>
              <th><i class="fas fa-envelope"></i> Email</th>
              <th><i class="fas fa-skiing"></i> Equipment</th>
              <th><i class="fas fa-info-circle"></i> Status</th>
              <th><i class="fas fa-clock"></i> Due By</th>
              <th><i class="fas fa-calendar"></i> Created</th>
              <th><i class="fas fa-tools"></i> Actions</th>
            </tr>
          </thead>
          <tbody id="workOrdersTable"></tbody>
        </table>

        <div id="listMessage" class="message"></div>
      </div>
    </div>

  </main>
</div>

<!-- ===============================
     Edit Work Order Modal
     =============================== -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Manage Equipment Item Status</h3>
    </div>
    <div id="modalBody" class="modal-body"></div>
    <div class="modal-footer">
      <button type="button" class="secondary-button" onclick="closeEditModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button type="button" id="notifyBtn" class="primary-button" onclick="notifyCustomer()" style="display: none;">
        <i class="fas fa-bell"></i> Send Notification
      </button>
      <button type="button" id="pickupBtn" class="primary-button" onclick="markAsPickup()" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <i class="fas fa-check-circle"></i> Mark Order as Picked Up
      </button>
    </div>
  </div>
</div>

<!-- ===============================
     Create Work Order Modal
     =============================== -->
<div id="createModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="createModalTitle">Create New Work Order - Step 1: Select Customer</h3>
      <button type="button" class="modal-close" onclick="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Step 1: Customer Search/Create -->
      <div id="customerStep" class="wizard-step">
        <div style="margin-bottom: 20px;">
          <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
            <button type="button" id="searchCustomerTab" class="tab-button active" onclick="switchCustomerMode('search')">
              Search Existing Customer
            </button>
            <button type="button" id="createCustomerTab" class="tab-button" onclick="switchCustomerMode('create')">
              Create New Customer
            </button>
          </div>

          <!-- Search Mode -->
          <div id="customerSearchMode" style="display: block;">
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">Search by Name, Email, or Phone</label>
              <input 
                type="text" 
                id="customerSearchInput" 
                placeholder="Enter name, email, or phone number..." 
                oninput="performCustomerSearch(this.value)"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
              />
              <p style="margin-top: 5px; font-size: 12px; color: #666;">Type at least 2 characters to search</p>
            </div>

            <div id="searchResultsContainer" style="display: none; margin-top: 15px;">
              <h4 style="margin-bottom: 10px;">Search Results:</h4>
              <div id="searchResults" style="border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                <!-- Results will be populated here -->
              </div>
            </div>

            <div id="noResultsMessage" style="display: none; text-align: center; padding: 20px; color: #666;">
              No customers found. Try creating a new customer.
            </div>
          </div>

          <!-- Create Mode -->
          <div id="customerCreateMode" style="display: none;">
            <form id="newCustomerForm" onsubmit="createNewCustomer(event)">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: 600;">First Name *</label>
                  <input type="text" id="newCustomerFirstName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: 600;">Last Name *</label>
                  <input type="text" id="newCustomerLastName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email *</label>
                <input type="email" id="newCustomerEmail" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Phone *</label>
                <input 
                  type="tel" 
                  id="newCustomerPhone" 
                  placeholder="1234567890 (10 digits)" 
                  required 
                  maxlength="10" 
                  pattern="[0-9]{10}"
                  oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10)"
                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                />
              </div>
              <button type="submit" class="primary-button" style="width: 100%;">
                <i class="fas fa-user-plus"></i> Create Customer & Continue
              </button>
            </form>
          </div>

          <div id="selectedCustomerDisplay" style="display: none; background: #e8f5e9; border: 1px solid #4caf50; padding: 15px; border-radius: 4px; margin-top: 15px;">
            <h4 style="margin-top: 0; color: #2e7d32;">✓ Customer Selected</h4>
            <p><strong>Name:</strong> <span id="selectedCustomerName"></span></p>
            <p><strong>Email:</strong> <span id="selectedCustomerEmail"></span></p>
            <p><strong>Phone:</strong> <span id="selectedCustomerPhone"></span></p>
            <button type="button" class="secondary-button" onclick="clearSelectedCustomer()" style="margin-top: 10px;">
              <i class="fas fa-edit"></i> Change Customer
            </button>
          </div>
        </div>
        <div id="customerStepMessage" class="message"></div>
      </div>

      <!-- Step 2: Equipment Details -->
      <div id="equipmentStep" class="wizard-step" style="display: none;">
        <form id="createWorkOrderForm">
          <div class="full-width" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
            <h4 style="margin-top: 0; color: #374151;">Work Order Details</h4>
            <div style="margin-bottom: 15px;">
              <label for="createPromisedBy" style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Due By (Promised Date) *</label>
              <input 
                type="date" 
                id="createPromisedBy" 
                name="promisedBy"
                required
                style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;"
                title="When this work order should be completed"
              />
              <small style="color: #6b7280; font-size: 12px;">Required: Set when this order should be completed</small>
            </div>
          </div>
          
          <!-- Existing Equipment Section -->
          <div id="existingEquipmentSection" class="full-width" style="display: none; margin-bottom: 20px;">
            <h4>Customer's Existing Equipment</h4>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Select equipment to add to this work order:</p>
            <div id="existingEquipmentList" style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; background: #fafbfc;">
              <!-- Existing equipment checkboxes will be populated here -->
            </div>
          </div>
          
          <div class="full-width">
            <h4>Add New Equipment</h4>
            <div id="createEquipmentItemsContainer">
              <!-- Equipment items will be added here dynamically -->
            </div>
            <button type="button" class="primary-button" onclick="addEquipmentItem()">
              <i class="fas fa-plus"></i> Add Equipment
            </button>
          </div>

          <!-- Work Order Notes Section -->
          <div class="full-width" style="margin-top: 20px; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
            <h4 style="margin-top: 0; color: #374151;">Initial Work Order Note (Optional)</h4>
            <p style="color: #6b7280; font-size: 13px; margin-bottom: 10px;">Add an initial note about this work order. You can add more notes later.</p>
            <textarea 
              id="createWorkOrderNoteText" 
              placeholder="e.g., Customer mentioned skis have edge damage, needs special attention..."
              style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-family: inherit; min-height: 80px; resize: vertical;"
            ></textarea>
          </div>

          <div id="createFormMessage" class="message"></div>
        </form>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="secondary-button" onclick="closeCreateModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button type="button" id="customerNextBtn" class="primary-button" onclick="proceedToEquipmentStep()" style="display: none;">
        <i class="fas fa-arrow-right"></i> Next: Equipment Selection
      </button>
      <button type="button" id="equipmentBackBtn" class="secondary-button" onclick="backToCustomerStep()" style="display: none;">
        <i class="fas fa-arrow-left"></i> Back
      </button>
      <button type="submit" form="createWorkOrderForm" class="primary-button" id="createSubmitBtn" style="display: none;">
        <i class="fas fa-arrow-right"></i> Continue
      </button>
    </div>
  </div>
</div>

<!-- ===============================
     Boot Requirements Modal (Second Modal)
     =============================== -->
<div id="bootModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Boot & Skier Information</h3>
      <button type="button" class="modal-close" onclick="closeBootModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="customerLookupSection">
        <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
          Looking up existing boots for <strong id="customerInfoDisplay"></strong>...
        </p>
        <div id="bootOptionsContainer" style="display: none;">
          <h4>Select Existing Boot or Create New</h4>
          <div id="existingBootOptions">
            <!-- Existing boot radio options will be populated here -->
          </div>
          <div style="margin: 15px 0;">
            <label>
              <input type="radio" name="bootChoice" value="new" id="newBootOption">
              <strong> Create New Boot</strong>
            </label>
          </div>
        </div>
      </div>
      
      <form id="bootRequirementsForm">
        <div id="bootItemsContainer">
          <!-- Boot requirement items will be added here dynamically -->
        </div>
        <div id="bootFormMessage" class="message"></div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="secondary-button" onclick="goBackToCreateModal()">
        <i class="fas fa-arrow-left"></i> Back
      </button>
      <button type="submit" form="bootRequirementsForm" class="primary-button" id="bootSubmitBtn" disabled>
        <i class="fas fa-plus"></i> Create Work Order
      </button>
    </div>
  </div>
</div>

<!-- Include shared JavaScript utilities -->
<script src="shared.js"></script>

<script>
  // Page-specific variables
  const tableBody = document.getElementById("workOrdersTable");
  const editModal = document.getElementById("editModal");
  const modalBody = document.getElementById("modalBody");
  const pickupBtn = document.getElementById("pickupBtn");
  const notifyBtn = document.getElementById("notifyBtn");
  const createModal = document.getElementById("createModal");
  const bootModal = document.getElementById("bootModal");
  const createEquipmentItemsContainer = document.getElementById("createEquipmentItemsContainer");
  const bootItemsContainer = document.getElementById("bootItemsContainer");
  const createSubmitBtn = document.getElementById("createSubmitBtn");

  let currentEditingOrderId = null;
  let currentActiveTab = 'RECEIVED'; // Track the currently active tab
  let equipmentItemCounter = 0;
  let capturedFormData = null; // Store data from first modal
  let customerBoots = []; // Store customer's existing boots
  let selectedBootChoice = null; // Track boot selection
  let customerEquipment = []; // Store customer's existing equipment
  let customerIdForEquipment = null; // Store customer ID when found
  let selectedCustomer = null; // Store selected/created customer
  let searchTimeout = null; // Debounce timer for search

  // Event delegation for service type changes and boot choices
  document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('service-type-select')) {
        toggleMountFields(e.target);
        updateSubmitButtonText();
      }
      if (e.target.name === 'bootChoice') {
        handleBootChoiceChange(e);
      }
    });
  });

  /* ===============================
     UI Helper Functions
     =============================== */
  function getModernStatusBadge(status) {
    const badges = {
      'RECEIVED': '<span class="status-badge badge-received"><i class="fas fa-inbox"></i> New</span>',
      'IN_PROGRESS': '<span class="status-badge badge-in-progress"><i class="fas fa-cog"></i> In Progress</span>',
      'READY_FOR_PICKUP': '<span class="status-badge badge-ready"><i class="fas fa-check-circle"></i> Ready</span>',
      'AWAITING_PICKUP': '<span class="status-badge badge-awaiting"><i class="fas fa-clock"></i> Awaiting</span>',
      'COMPLETED': '<span class="status-badge badge-completed"><i class="fas fa-check-double"></i> Completed</span>',
      'PENDING': '<span class="status-badge badge-received"><i class="fas fa-hourglass-half"></i> Pending</span>',
      'DONE': '<span class="status-badge badge-ready"><i class="fas fa-check"></i> Done</span>',
      'PICKED_UP': '<span class="status-badge badge-completed"><i class="fas fa-check-double"></i> Picked Up</span>'
    };
    return badges[status] || `<span class="status-badge">${status}</span>`;
  }
  
  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  /* ===============================
     Authentication Management
     =============================== */
  function handleLogin() {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value.trim();

    ValidationUtils.clearMessage('loginMessage');

    if (!email || !password) {
      ValidationUtils.showMessage('loginMessage', 'Please enter both email and password.', true);
      return;
    }

    if (!ValidationUtils.isValidEmail(email)) {
      ValidationUtils.showMessage('loginMessage', 'Please enter a valid email address.', true);
      return;
    }

    // Attempt login
    AuthUtils.login(email, password)
      .then(response => {
        document.getElementById("userEmail").textContent = email;
        showAuthenticatedView();
        fetchWorkOrdersByStatus(currentActiveTab);
      })
      .catch(error => {
        ValidationUtils.showMessage('loginMessage', 'Invalid credentials. Please try again.', true);
      });
  }

  function handleLogout() {
    AuthUtils.logout();
  }

  function showAuthenticatedView() {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("authenticatedSection").style.display = "block";
  }

  function showLoginView() {
    document.getElementById("loginSection").style.display = "block";
    document.getElementById("authenticatedSection").style.display = "none";
    ValidationUtils.clearMessage('loginMessage');
  }

  /* ===============================
     Modal Functions
     =============================== */
  function openEditModal(orderId) {
    currentEditingOrderId = orderId;
    editModal.style.display = "block";
    loadOrderForEditing(orderId);
  }

  function closeEditModal() {
    editModal.style.display = "none";
    currentEditingOrderId = null;
    modalBody.innerHTML = "";
  }

  // Click outside modal to close
  window.onclick = function(event) {
    if (event.target === editModal) {
      closeEditModal();
    }
  };

  /* ===============================
     Load Order for Editing
     =============================== */
  async function loadOrderForEditing(orderId) {
    try {
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.WORKORDERS}/${orderId}`);
      const order = await response.json();

      modalBody.innerHTML = `
        <div style="margin-bottom: 15px;">
          <strong>Customer:</strong> ${order.customerName}<br>
          <strong>Work Order Status:</strong> 
          <span class="status-badge status-${order.status}">${order.status}</span>
          <small style="display: block; color: #666; margin-top: 5px; font-style: italic;">
            Status is automatically calculated from item statuses below
          </small>
          ${order.status === "COMPLETED" ? '<div style="color: #28a745; margin-top: 10px; font-weight: bold;">✓ Order is ready for customer pickup</div>' : ''}
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
          <label for="editPromisedBy" style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Due By (Promised Date)</label>
          <input 
            type="datetime-local" 
            id="editPromisedBy" 
            name="promisedBy"
            value="${order.promisedBy ? new Date(order.promisedBy).toISOString().slice(0, -1) : ''}"
            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;"
            title="When this work order should be completed"
            onchange="updateWorkOrderPromisedBy(${orderId}, this.value)"
          />
          <small style="color: #6b7280; font-size: 12px;">Optional: Set when this order should be completed</small>
        </div>

        <h4>Equipment Items</h4>
        <p style="margin: 10px 0; font-size: 14px; color: #666;">
          Update individual item statuses below. Work order status updates automatically:
          <br><strong>RECEIVED:</strong> all items PENDING • <strong>IN_PROGRESS:</strong> any item IN_PROGRESS • <strong>READY_FOR_PICKUP:</strong> all items DONE • <strong>AWAITING_PICKUP:</strong> customer notified • <strong>COMPLETED:</strong> all items picked up
        </p>
        <div id="equipmentStatusItems"></div>

        <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
          <h4 style="margin-top: 0; color: #374151;">Work Order Notes</h4>
          
          <div style="margin-bottom: 20px;">
            <textarea 
              id="newWorkOrderNoteText" 
              placeholder="Add a note about this work order..."
              style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-family: inherit; min-height: 80px; resize: vertical;"
            ></textarea>
            <button 
              type="button" 
              class="primary-button" 
              onclick="submitWorkOrderNote(${orderId})"
              style="margin-top: 10px;"
            >
              <i class="fas fa-save"></i> Save Note
            </button>
          </div>

          <div id="workOrderNotesFeed"></div>
        </div>
      `;

      const equipmentStatusItems = document.getElementById("equipmentStatusItems");

      // Check order status variables (needed for rendering equipment items)
      // Fail safely if items array is empty - empty array should not be "all done"
      const allDone = order.equipment && order.equipment.length > 0 && order.equipment.every(equip => equip.status === "DONE");
      const isReadyForPickup = order.status === "READY_FOR_PICKUP";
      const isCompleted = order.status === "COMPLETED";

      if (!order.equipment || order.equipment.length === 0) {
        equipmentStatusItems.innerHTML = '<div class="empty-message">No equipment in this work order</div>';
        notifyBtn.style.display = "none";
        pickupBtn.style.display = "none";
      } else {
        equipmentStatusItems.innerHTML = order.equipment.map(item => `
          <div class="equipment-status-row">
            <div class="equipment-info">
              <strong>${item.brand} ${item.model}</strong> (${item.serviceType})<br>
              <span style="font-size: 12px; color: #666;">Current status: 
                <span class="status-badge status-${item.status}">${item.status}</span>
              </span>
            </div>
            <select class="equipment-status-select" data-equipment-id="${item.id}" onchange="updateEquipmentStatus(${orderId}, ${item.id}, this.value)" ${(item.status === "PICKED_UP" || isCompleted) ? "disabled" : ""}>
              <option value="PENDING" ${item.status === "PENDING" ? "selected" : ""}>PENDING</option>
              <option value="IN_PROGRESS" ${item.status === "IN_PROGRESS" ? "selected" : ""}>IN_PROGRESS</option>
              <option value="DONE" ${item.status === "DONE" ? "selected" : ""}>DONE</option>
              <option value="PICKED_UP" ${item.status === "PICKED_UP" ? "selected" : ""}>PICKED_UP</option>
            </select>
          </div>
        `).join("");
        
        // Button visibility logic based on workflow state
        const isReadyForPickup = order.status === "READY_FOR_PICKUP";
        const isAwaitingPickup = order.status === "AWAITING_PICKUP";
        
        // Show "Send Notification" button ONLY when:
        // - order.status === 'READY_FOR_PICKUP' AND all items have status === 'DONE'
        notifyBtn.style.display = (isReadyForPickup && allDone) ? "block" : "none";
        
        // Show "Mark as Picked Up" button ONLY when:
        // - order.status === 'AWAITING_PICKUP'
        pickupBtn.style.display = isAwaitingPickup ? "block" : "none";
      }

      // Load work order notes
      loadWorkOrderNotes(orderId);
    } catch (error) {
      console.error(error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        modalBody.innerHTML = '<div class="error">Failed to load work order.</div>';
        notifyBtn.style.display = "none";
        pickupBtn.style.display = "none";
      }
    }
  }

  /* ===============================
     Update Equipment Status
     =============================== */
  async function updateEquipmentStatus(orderId, equipmentId, newStatus) {
    try {
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.WORKORDERS}/${orderId}/equipment/${equipmentId}/status`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });

      if (!response.ok) throw new Error("Failed to update status");

      // Reload the modal to reflect changes
      loadOrderForEditing(orderId);
      // Reload the main list
      refreshCurrentTab();
    } catch (error) {
      console.error(error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        alert("Error updating equipment status: " + error.message);
      }
    }
  }

  /* ===============================
     Update Work Order Promised By Date
     =============================== */
  async function updateWorkOrderPromisedBy(orderId, promisedByValue) {
    try {
      // Convert empty string to null for backend
      const promisedBy = promisedByValue ? promisedByValue : null;
      
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.WORKORDERS}/${orderId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ promisedBy: promisedBy })
      });

      if (!response.ok) throw new Error("Failed to update promised by date");

      // Show success feedback
      const input = document.getElementById('editPromisedBy');
      if (input) {
        const originalBorder = input.style.border;
        input.style.border = '2px solid #059669';
        setTimeout(() => {
          input.style.border = originalBorder;
        }, 1000);
      }
      
      // Reload the main list to reflect the new due date
      refreshCurrentTab();
    } catch (error) {
      console.error(error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        alert("Error updating promise date: " + error.message);
        // Reload the modal to restore original value
        loadOrderForEditing(orderId);
      }
    }
  }

  /* ===============================
     Customer Notification
     Notifies customer and transitions to AWAITING_PICKUP
     =============================== */
  async function notifyCustomer() {
    if (!currentEditingOrderId) return;

    try {
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.WORKORDERS}/${currentEditingOrderId}/notify`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      if (!response.ok) throw new Error("Failed to send notification");

      alert("Customer has been notified that their order is ready for pickup!");
      closeEditModal();
      refreshCurrentTab();
    } catch (error) {
      console.error(error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        alert("Error sending notification: " + error.message);
      }
    }
  }

  /* ===============================
     Mark as Pickup (Atomic Operation)
     Updates ALL items to PICKED_UP and work order to COMPLETED
     =============================== */
  async function markAsPickup() {
    if (!currentEditingOrderId) return;

    try {
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.WORKORDERS}/${currentEditingOrderId}/pickup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      if (!response.ok) throw new Error("Failed to mark as pickup");

      alert("Work order marked as PICKED UP! All items have been collected by the customer.");
      closeEditModal();
      refreshCurrentTab();
    } catch (error) {
      console.error(error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        alert("Error marking as pickup: " + error.message);
      }
    }
  }

  /* ===============================
     Work Order Notes Functions
     =============================== */
  async function loadWorkOrderNotes(orderId) {
    try {
      const response = await APIUtils.authenticatedFetch(`/api/workorders/${orderId}/notes`);
      if (!response.ok) throw new Error("Failed to load notes");

      const notes = await response.json();
      const notesFeed = document.getElementById('workOrderNotesFeed');
      
      if (!notesFeed) return; // Feed not rendered yet

      if (notes.length === 0) {
        notesFeed.innerHTML = '<div style="padding: 15px; text-align: center; color: #94a3b8; font-style: italic;">No notes yet</div>';
      } else {
        notesFeed.innerHTML = notes.map(note => {
          const noteDate = new Date(note.createdAt);
          const formattedDate = noteDate.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          return `
            <div style="padding: 12px; margin-bottom: 10px; background: white; border: 1px solid #e2e8f0; border-radius: 4px;">
              <div style="font-size: 13px; color: #64748b; margin-bottom: 5px;">
                <strong>${note.createdBy}</strong> • ${formattedDate}
              </div>
              <div style="color: #334155; white-space: pre-wrap;">${note.noteText}</div>
            </div>
          `;
        }).join('');
      }
    } catch (error) {
      console.error('Error loading notes:', error);
      const notesFeed = document.getElementById('workOrderNotesFeed');
      if (notesFeed) {
        notesFeed.innerHTML = '<div style="color: #ef4444; padding: 10px;">Failed to load notes</div>';
      }
    }
  }

  async function submitWorkOrderNote(orderId) {
    const noteTextarea = document.getElementById('newWorkOrderNoteText');
    const noteText = noteTextarea.value.trim();

    if (!noteText) {
      alert('Please enter a note');
      return;
    }

    try {
      // Get current user from localStorage
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const createdBy = user.username || 'Staff';

      const response = await APIUtils.authenticatedFetch(`/api/workorders/${orderId}/notes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          noteText: noteText,
          createdBy: createdBy
        })
      });

      if (!response.ok) throw new Error('Failed to save note');

      // Clear textarea
      noteTextarea.value = '';
      
      // Reload notes
      await loadWorkOrderNotes(orderId);
    } catch (error) {
      console.error('Error saving note:', error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        alert('Error saving note: ' + error.message);
      }
    }
  }

  /* ===============================
     Tab Management Functions
     =============================== */
  function switchTab(statusOrServiceType, buttonElement) {
    // Update active tab
    currentActiveTab = statusOrServiceType;
    
    // Update button states
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    buttonElement.classList.add('active');
    
    // Check if this is a service type tab or status tab
    const serviceTypes = ['TUNE', 'MOUNT', 'REPAIR'];
    
    if (serviceTypes.includes(statusOrServiceType)) {
      // This is a service type filter
      fetchWorkOrdersByServiceType(statusOrServiceType);
    } else {
      // This is a status filter
      fetchWorkOrdersByStatus(statusOrServiceType);
    }
  }

  function refreshCurrentTab() {
    // Check if current tab is a service type or status
    const serviceTypes = ['TUNE', 'MOUNT', 'REPAIR'];
    
    if (serviceTypes.includes(currentActiveTab)) {
      fetchWorkOrdersByServiceType(currentActiveTab);
    } else {
      fetchWorkOrdersByStatus(currentActiveTab);
    }
  }

  /* ===============================
     Fetch Multiple Status Work Orders (for Completed Tab)
     =============================== */
  async function fetchMultipleStatuses(statuses) {
    if (!AuthUtils.isAuthenticated()) {
      showLoginView();
      return;
    }

    try {
      // Fetch work orders for each status and combine results
      const promises = statuses.map(status => 
        APIUtils.authenticatedFetch(`${API_CONFIG.WORKORDERS}?status=${encodeURIComponent(status)}`)
          .then(response => response.json())
      );
      
      const results = await Promise.all(promises);
      const allWorkOrders = results.flat(); // Combine all arrays into one
      
      // Debug logging
      console.log('Fetching work orders with statuses:', statuses);
      console.log('Combined results:', allWorkOrders);

      tableBody.innerHTML = "";
      ValidationUtils.clearMessage('listMessage');

      if (allWorkOrders.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="9">
          <div class="empty-state">
            <i class="fas fa-clipboard-list"></i>
            <h3>No work orders found</h3>
            <p>No work orders match the current filter. Try switching to a different tab or create a new work order.</p>
          </div>
        </td></tr>`;
        return;
      }

      // Sort by due date (promisedBy) first, then creation date (oldest first)
      allWorkOrders.sort((a, b) => {
        // Handle null promisedBy values - put them at the end
        if (!a.promisedBy && !b.promisedBy) {
          return new Date(a.createdAt) - new Date(b.createdAt);
        }
        if (!a.promisedBy) return 1; // a goes after b
        if (!b.promisedBy) return -1; // a goes before b
        
        // Both have promisedBy dates, sort by them
        const promisedDiff = new Date(a.promisedBy) - new Date(b.promisedBy);
        if (promisedDiff !== 0) return promisedDiff;
        
        // Same promisedBy date, sort by createdAt
        return new Date(a.createdAt) - new Date(b.createdAt);
      });

      allWorkOrders.forEach(order => {
        const row = document.createElement("tr");

        // Count equipment items by status
        const equipmentItems = order.equipment || [];
        const doneCount = equipmentItems.filter(item => item.status === "DONE").length;
        const totalCount = equipmentItems.length;

        const equipmentSummary = equipmentItems.length > 0 
          ? `${equipmentItems.map(item => `${item.brand} ${item.model} <span style="font-weight: 700; color: #3b82f6;">(${item.serviceType})</span> ${getModernStatusBadge(item.status)}`).join("<br>")}`
          : "No equipment";

        row.innerHTML = `
          <td>${order.id}</td>
          <td><strong>${order.customerName || ""}</strong></td>
          <td>${order.customerPhone || ""}</td>
          <td>${order.customerEmail || ""}</td>
          <td>${equipmentSummary}</td>
          <td>${getModernStatusBadge(order.status)}<br><small style="color: #64748b;">${doneCount}/${totalCount} items done</small></td>
          <td style="color: ${order.promisedBy ? '#059669' : '#6b7280'}; font-weight: ${order.promisedBy ? '600' : 'normal'};">${order.promisedBy ? formatDate(order.promisedBy) : "Not Set"}</td>
          <td>${formatDate(order.createdAt) || ""}</td>
          <td class="action-buttons">
            <button type="button" class="action-btn btn-edit" onclick="openEditModal(${order.id})">
              <i class="fas fa-edit"></i> Manage
            </button>
          </td>
        `;

        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error("Error fetching work orders:", error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        ValidationUtils.showMessage('listMessage', 'Failed to load work orders.', true);
      }
    }
  }

  /* ===============================
     Customer Search & Selection Functions
     =============================== */
  function switchCustomerMode(mode) {
    const searchMode = document.getElementById('customerSearchMode');
    const createMode = document.getElementById('customerCreateMode');
    const searchTab = document.getElementById('searchCustomerTab');
    const createTab = document.getElementById('createCustomerTab');

    if (mode === 'search') {
      searchMode.style.display = 'block';
      createMode.style.display = 'none';
      searchTab.classList.add('active');
      createTab.classList.remove('active');
    } else {
      searchMode.style.display = 'none';
      createMode.style.display = 'block';
      searchTab.classList.remove('active');
      createTab.classList.add('active');
    }

    ValidationUtils.clearMessage('customerStepMessage');
  }

  function performCustomerSearch(query) {
    // Clear previous timeout
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }

    const resultsContainer = document.getElementById('searchResultsContainer');
    const searchResults = document.getElementById('searchResults');
    const noResults = document.getElementById('noResultsMessage');

    // Hide results if query is too short
    if (query.length < 2) {
      resultsContainer.style.display = 'none';
      noResults.style.display = 'none';
      return;
    }

    // Debounce search (wait 300ms after user stops typing)
    searchTimeout = setTimeout(async () => {
      try {
        ValidationUtils.clearMessage('customerStepMessage');

        // Determine search type
        const params = new URLSearchParams();
        if (query.includes('@')) {
          params.append('email', query);
        } else if (/^\d+$/.test(query)) {
          params.append('phone', query);
        } else {
          params.append('name', query);
        }

        const response = await APIUtils.authenticatedFetch(`${API_CONFIG.CUSTOMERS}/search?${params.toString()}`);
        const customers = await response.json();

        if (customers && customers.length > 0) {
          // Display results
          searchResults.innerHTML = customers.map(customer => `
            <div class="search-result-item" onclick='handleSelectCustomer(${JSON.stringify(customer)})'>
              <div style="font-weight: 600; font-size: 14px;">${customer.firstName} ${customer.lastName}</div>
              <div style="font-size: 12px; color: #666;">${customer.email} | ${customer.phone}</div>
            </div>
          `).join('');
          resultsContainer.style.display = 'block';
          noResults.style.display = 'none';
        } else {
          // No results found
          resultsContainer.style.display = 'none';
          noResults.style.display = 'block';
        }
      } catch (error) {
        console.error('Search error:', error);
        ValidationUtils.showMessage('customerStepMessage', 'Search failed. Please try again.', true);
        resultsContainer.style.display = 'none';
        noResults.style.display = 'none';
      }
    }, 300);
  }

  // Wrapper function to handle async selectCustomer from onclick
  function handleSelectCustomer(customer) {
    selectCustomer(customer).catch(error => {
      console.error('Error selecting customer:', error);
      ValidationUtils.showMessage('customerStepMessage', 'Failed to load customer equipment', true);
    });
  }

  async function selectCustomer(customer) {
    selectedCustomer = customer;

    // Hide search/create UI
    document.getElementById('customerSearchMode').style.display = 'none';
    document.getElementById('customerCreateMode').style.display = 'none';
    document.getElementById('searchCustomerTab').style.display = 'none';
    document.getElementById('createCustomerTab').style.display = 'none';

    // Show selected customer display
    const selectedDisplay = document.getElementById('selectedCustomerDisplay');
    document.getElementById('selectedCustomerName').textContent = `${customer.firstName} ${customer.lastName}`;
    document.getElementById('selectedCustomerEmail').textContent = customer.email;
    document.getElementById('selectedCustomerPhone').textContent = customer.phone;
    selectedDisplay.style.display = 'block';

    // Fetch customer equipment immediately
    await fetchCustomerEquipment(customer.id);

    // Show next button
    document.getElementById('customerNextBtn').style.display = 'inline-block';

    ValidationUtils.clearMessage('customerStepMessage');
  }

  async function fetchCustomerEquipment(customerId) {
    try {
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.CUSTOMERS}/${customerId}/equipment`);
      if (response.ok) {
        customerEquipment = await response.json();
        customerIdForEquipment = customerId;
      } else {
        customerEquipment = [];
        customerIdForEquipment = null;
      }
    } catch (error) {
      console.error('Error fetching customer equipment:', error);
      customerEquipment = [];
      customerIdForEquipment = null;
    }
  }

  function clearSelectedCustomer() {
    selectedCustomer = null;

    // Show search/create UI
    document.getElementById('customerSearchMode').style.display = 'block';
    document.getElementById('searchCustomerTab').style.display = 'inline-block';
    document.getElementById('createCustomerTab').style.display = 'inline-block';

    // Hide selected customer display
    document.getElementById('selectedCustomerDisplay').style.display = 'none';
    document.getElementById('customerNextBtn').style.display = 'none';

    // Reset search
    document.getElementById('customerSearchInput').value = '';
    document.getElementById('searchResultsContainer').style.display = 'none';
    document.getElementById('noResultsMessage').style.display = 'none';

    // Clear equipment data
    customerEquipment = [];
    customerIdForEquipment = null;

    // Switch back to search mode
    switchCustomerMode('search');
  }

  async function createNewCustomer(event) {
    event.preventDefault();
    ValidationUtils.clearMessage('customerStepMessage');

    const firstName = document.getElementById('newCustomerFirstName').value.trim();
    const lastName = document.getElementById('newCustomerLastName').value.trim();
    const email = document.getElementById('newCustomerEmail').value.trim();
    const phone = document.getElementById('newCustomerPhone').value.trim();

    // Validation
    if (!firstName || !lastName || !email || !phone) {
      ValidationUtils.showMessage('customerStepMessage', 'All fields are required', true);
      return;
    }

    if (phone.length !== 10) {
      ValidationUtils.showMessage('customerStepMessage', 'Phone number must be 10 digits', true);
      return;
    }

    try {
      // Check for duplicate customer first
      const lookupResponse = await APIUtils.authenticatedFetch(`/customers/lookup?email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}`);
      
      if (lookupResponse.ok) {
        const existing = await lookupResponse.json();
        if (existing) {
          if (confirm('A customer with this email/phone already exists. Use existing customer?')) {
            await selectCustomer(existing);
            return;
          } else {
            return;
          }
        }
      }

      // Create new customer
      const createResponse = await APIUtils.authenticatedFetch('/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ firstName, lastName, email, phone })
      });

      if (!createResponse.ok) {
        throw new Error('Failed to create customer');
      }

      const newCustomer = await createResponse.json();
      await selectCustomer(newCustomer);

    } catch (error) {
      console.error('Error creating customer:', error);
      ValidationUtils.showMessage('customerStepMessage', 'Failed to create customer: ' + error.message, true);
    }
  }

  function proceedToEquipmentStep() {
    if (!selectedCustomer) {
      ValidationUtils.showMessage('customerStepMessage', 'Please select or create a customer first', true);
      return;
    }

    // Hide customer step
    document.getElementById('customerStep').style.display = 'none';
    document.getElementById('customerNextBtn').style.display = 'none';

    // Show equipment step
    document.getElementById('equipmentStep').style.display = 'block';
    document.getElementById('equipmentBackBtn').style.display = 'inline-block';
    document.getElementById('createSubmitBtn').style.display = 'inline-block';

    // Update modal title
    document.getElementById('createModalTitle').textContent = 'Create New Work Order - Step 2: Equipment Selection';

    // Display existing equipment section
    displayExistingEquipment();

    // Update button text based on service selections
    updateSubmitButtonText();
  }

  function displayExistingEquipment() {
    const existingSection = document.getElementById('existingEquipmentSection');
    const existingList = document.getElementById('existingEquipmentList');
    
    if (!customerEquipment || customerEquipment.length === 0) {
      existingSection.style.display = 'none';
      return;
    }
    
    existingSection.style.display = 'block';
    existingList.innerHTML = '';
    
    customerEquipment.forEach((equipment, index) => {
      const equipmentRow = document.createElement('div');
      equipmentRow.style.cssText = 'display: grid; grid-template-columns: auto 1fr 200px; gap: 10px; align-items: center; padding: 10px; border-bottom: 1px solid #e2e8f0;';
      equipmentRow.setAttribute('data-equipment-id', equipment.id);
      
      // Checkbox
      const checkboxCell = document.createElement('div');
      checkboxCell.innerHTML = `
        <input 
          type="checkbox" 
          id="existingEquip-${equipment.id}" 
          class="existing-equipment-checkbox"
          onchange="toggleExistingEquipmentService(${equipment.id})"
          style="width: 18px; height: 18px; cursor: pointer;"
        />
      `;
      
      // Equipment summary
      const summaryCell = document.createElement('div');
      summaryCell.innerHTML = `
        <label for="existingEquip-${equipment.id}" style="cursor: pointer; font-weight: 500;">
          ${equipment.brand} ${equipment.model}
          ${equipment.length ? ` - ${equipment.length}cm` : ''}
        </label>
        <div style="font-size: 12px; color: #666; margin-top: 2px;">
          ${equipment.condition} | Type: ${equipment.type} | Level: ${equipment.abilityLevel}
        </div>
      `;
      
      // Service type dropdown (disabled initially)
      const serviceCell = document.createElement('div');
      serviceCell.innerHTML = `
        <select 
          id="service-${equipment.id}" 
          class="existing-equipment-service"
          disabled
          style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6; cursor: not-allowed;"
        >
          <option value="">Select Service</option>
          <option value="TUNE">Tune</option>
          <option value="MOUNT">Mount</option>
          <option value="REPAIR">Repair</option>
        </select>
      `;
      
      equipmentRow.appendChild(checkboxCell);
      equipmentRow.appendChild(summaryCell);
      equipmentRow.appendChild(serviceCell);
      existingList.appendChild(equipmentRow);
    });
  }

  function toggleExistingEquipmentService(equipmentId) {
    const checkbox = document.getElementById(`existingEquip-${equipmentId}`);
    const serviceSelect = document.getElementById(`service-${equipmentId}`);
    
    if (checkbox.checked) {
      // Enable service dropdown
      serviceSelect.disabled = false;
      serviceSelect.style.background = '#ffffff';
      serviceSelect.style.cursor = 'pointer';
      serviceSelect.style.border = '1px solid #d1d5db';
      
      // Add event listener to clear error styling when service is selected
      serviceSelect.addEventListener('change', function() {
        if (this.value) {
          this.style.border = '1px solid #d1d5db';
        }
        // Update button text when service type changes
        updateSubmitButtonText();
      });
    } else {
      // Disable and clear service dropdown
      serviceSelect.disabled = true;
      serviceSelect.value = '';
      serviceSelect.style.background = '#f3f4f6';
      serviceSelect.style.cursor = 'not-allowed';
      serviceSelect.style.border = '1px solid #d1d5db';
      
      // Update button text when checkbox is unchecked
      updateSubmitButtonText();
    }
  }

  function backToCustomerStep() {
    // Show customer step
    document.getElementById('customerStep').style.display = 'block';
    document.getElementById('customerNextBtn').style.display = 'inline-block';

    // Hide equipment step
    document.getElementById('equipmentStep').style.display = 'none';
    document.getElementById('equipmentBackBtn').style.display = 'none';
    document.getElementById('createSubmitBtn').style.display = 'none';

    // Update modal title
    document.getElementById('createModalTitle').textContent = 'Create New Work Order - Step 1: Select Customer';
  }

  async function loadCustomerEquipmentForWizard() {
    if (!selectedCustomer || !selectedCustomer.id) return;

    try {
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.CUSTOMERS}/${selectedCustomer.id}/equipment`);
      if (response.ok) {
        customerEquipment = await response.json();
        customerIdForEquipment = selectedCustomer.id;

        // Update any existing equipment rows with equipment options
        const equipmentRows = createEquipmentItemsContainer.querySelectorAll('.equipment-item-row');
        equipmentRows.forEach(row => {
          loadAndDisplayEquipment(row, selectedCustomer.email, selectedCustomer.phone);
        });
      }
    } catch (error) {
      console.error('Error loading customer equipment:', error);
    }
  }

  /* ===============================
     Create Work Order Modal Functions
     =============================== */
  function openCreateModal() {
    createModal.style.display = "block";
    resetCreateForm();
  }

  function closeCreateModal() {
    createModal.style.display = "none";
    resetCreateForm();
  }

  function openBootModal() {
    bootModal.style.display = "block";
    populateBootModal();
  }

  function closeBootModal() {
    bootModal.style.display = "none";
    bootItemsContainer.innerHTML = "";
    ValidationUtils.clearMessage('bootFormMessage');
    customerBoots = [];
    selectedBootChoice = null;
    document.getElementById('bootOptionsContainer').style.display = 'none';
    
    // Reset button state
    const bootSubmitBtn = document.getElementById('bootSubmitBtn');
    if (bootSubmitBtn) {
      bootSubmitBtn.disabled = true;
      bootSubmitBtn.textContent = 'Create Work Order';
    }
  }

  function goBackToCreateModal() {
    closeBootModal();
    createModal.style.display = "block";
  }

  function resetCreateForm() {
    // Reset wizard to step 1
    document.getElementById('customerStep').style.display = 'block';
    document.getElementById('equipmentStep').style.display = 'none';
    document.getElementById('customerNextBtn').style.display = 'none';
    document.getElementById('equipmentBackBtn').style.display = 'none';
    document.getElementById('createSubmitBtn').style.display = 'none';
    document.getElementById('createModalTitle').textContent = 'Create New Work Order - Step 1: Select Customer';

    // Reset customer selection
    selectedCustomer = null;
    clearSelectedCustomer();

    // Reset forms
    document.getElementById("createWorkOrderForm").reset();
    document.getElementById("newCustomerForm").reset();
    createEquipmentItemsContainer.innerHTML = "";
    
    // Clear work order note textarea
    const noteTextarea = document.getElementById('createWorkOrderNoteText');
    if (noteTextarea) {
      noteTextarea.value = '';
    }
    
    // Clear existing equipment section
    document.getElementById('existingEquipmentSection').style.display = 'none';
    document.getElementById('existingEquipmentList').innerHTML = '';
    
    ValidationUtils.clearMessage('createFormMessage');
    capturedFormData = null;
    equipmentItemCounter = 0; // Reset the equipment counter
    customerEquipment = []; // Reset customer equipment
    customerIdForEquipment = null; // Reset customer ID
    updateSubmitButtonText();
  }

  // Close modal when clicking outside or on close button
  window.onclick = function(event) {
    if (event.target === editModal) {
      closeEditModal();
    }
    if (event.target === createModal) {
      closeCreateModal();
    }
    if (event.target === bootModal) {
      closeBootModal();
    }
  };

  // Close modal on Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      if (editModal.style.display === 'block') {
        closeEditModal();
      }
      if (createModal.style.display === 'block') {
        closeCreateModal();
      }
      if (bootModal.style.display === 'block') {
        closeBootModal();
      }
    }
  });

  /* ===============================
     Mount Service Detection and UI Updates
     =============================== */
  function hasMountService() {
    // Check new equipment items
    const newEquipmentServiceSelects = createEquipmentItemsContainer.querySelectorAll('.service-type-select');
    const hasNewEquipmentMount = Array.from(newEquipmentServiceSelects).some(select => select.value === 'MOUNT');
    
    // Check existing equipment items
    const existingEquipmentServiceSelects = document.querySelectorAll('.existing-equipment-service');
    const hasExistingEquipmentMount = Array.from(existingEquipmentServiceSelects).some(select => {
      // Only count checked equipment items
      const equipmentId = select.id.replace('service-', '');
      const checkbox = document.getElementById(`existingEquip-${equipmentId}`);
      return checkbox && checkbox.checked && select.value === 'MOUNT';
    });
    
    return hasNewEquipmentMount || hasExistingEquipmentMount;
  }

  function updateSubmitButtonText() {
    if (hasMountService()) {
      createSubmitBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Enter Boot and Binding Information';
    } else {
      createSubmitBtn.innerHTML = '<i class="fas fa-check"></i> Create Work Order';
    }
  }

  function populateBootModal() {
    if (!capturedFormData) return;

    // Display customer info
    const customerName = `${capturedFormData.customerFirstName} ${capturedFormData.customerLastName}`;
    const customerContact = `${capturedFormData.email} | ${capturedFormData.phone}`;
    document.getElementById('customerInfoDisplay').textContent = `${customerName} (${customerContact})`;

    // Lookup customer boots
    lookupCustomerBoots(capturedFormData.email, capturedFormData.phone);
  }

  /* ===============================
     Customer Boot Lookup and Management
     =============================== */
  async function lookupCustomerBoots(email, phone) {
    try {
      // Show loading state
      document.getElementById('customerInfoDisplay').innerHTML = `
        ${capturedFormData.customerFirstName} ${capturedFormData.customerLastName} (${email} | ${phone})
        <br><span style="color: #007bff; font-size: 12px;">🔍 Looking up existing boots...</span>
      `;
      
      // Use a customer lookup endpoint with email and phone
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.WORKORDERS}/customer/boots?email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}`);
      
      if (response.ok) {
        customerBoots = await response.json();
        document.getElementById('customerInfoDisplay').innerHTML = `
          ${capturedFormData.customerFirstName} ${capturedFormData.customerLastName} (${email} | ${phone})
          <br><span style="color: #28a745; font-size: 12px;">✓ Found ${customerBoots.length} existing boot${customerBoots.length !== 1 ? 's' : ''}</span>
        `;
        displayBootOptions();
      } else {
        // Customer not found or no boots, show new boot form
        customerBoots = [];
        document.getElementById('customerInfoDisplay').innerHTML = `
          ${capturedFormData.customerFirstName} ${capturedFormData.customerLastName} (${email} | ${phone})
          <br><span style="color: #6c757d; font-size: 12px;">ℹ No existing boots found - new customer or first boot purchase</span>
        `;
        displayBootOptions();
      }
    } catch (error) {
      console.error('Error looking up customer boots:', error);
      // Fallback to new boot creation
      customerBoots = [];
      document.getElementById('customerInfoDisplay').innerHTML = `
        ${capturedFormData.customerFirstName} ${capturedFormData.customerLastName} (${email} | ${phone})
        <br><span style="color: #dc3545; font-size: 12px;">⚠ Could not lookup existing boots - proceeding with new boot creation</span>
      `;
      displayBootOptions();
    }
  }

  function displayBootOptions() {
    const existingBootOptions = document.getElementById('existingBootOptions');
    const bootOptionsContainer = document.getElementById('bootOptionsContainer');
    
    existingBootOptions.innerHTML = '';
    
    if (customerBoots && customerBoots.length > 0) {
      // Show existing boots as radio options
      customerBoots.forEach((boot, index) => {
        const bootLabel = document.createElement('div');
        bootLabel.style.marginBottom = '10px';
        bootLabel.innerHTML = `
          <label style="display: block; padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            <input type="radio" name="bootChoice" value="existing-${index}" style="margin-right: 10px;">
            <strong>${boot.brand} ${boot.model}</strong><br>
            <small style="color: #666;">BSL: ${boot.bsl}mm | Height: ${Math.floor(boot.heightInches/12)}'${boot.heightInches%12}" | Weight: ${boot.weight}lbs | Age: ${boot.age} | Level: ${boot.abilityLevel}</small>
          </label>
        `;
        existingBootOptions.appendChild(bootLabel);
      });
    } else {
      existingBootOptions.innerHTML = '<p style="color: #666; font-style: italic; margin-bottom: 15px;">No existing boots found for this customer.</p>';
    }
    
    bootOptionsContainer.style.display = 'block';
    
    // Add event listeners for boot choice selection
    const bootChoiceRadios = document.querySelectorAll('input[name="bootChoice"]');
    bootChoiceRadios.forEach(radio => {
      radio.addEventListener('change', handleBootChoiceChange);
    });
  }

  /* ===============================
     Customer Equipment Lookup
     =============================== */
  async function lookupCustomerEquipment(email, phone) {
    try {
      // Look up customer by email and phone to get customer ID
      const response = await APIUtils.authenticatedFetch(`${API_CONFIG.WORKORDERS}/customer/boots?email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}`);
      
      if (response.ok) {
        const boots = await response.json();
        // Extract customer ID from the boots response (if boots exist)
        // Or we need to look up customer separately
        // For now, let's try to get customer by lookup endpoint
        const customerResponse = await APIUtils.authenticatedFetch(`/customers/lookup?email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}`);
        
        if (customerResponse.ok) {
          const customer = await customerResponse.json();
          customerIdForEquipment = customer.id;
          
          // Now fetch equipment for this customer
          const equipmentResponse = await APIUtils.authenticatedFetch(`${API_CONFIG.CUSTOMERS}/${customerIdForEquipment}/equipment`);
          
          if (equipmentResponse.ok) {
            customerEquipment = await equipmentResponse.json();
          } else {
            customerEquipment = [];
          }
        } else {
          customerEquipment = [];
          customerIdForEquipment = null;
        }
      } else {
        customerEquipment = [];
        customerIdForEquipment = null;
      }
    } catch (error) {
      console.error('Error looking up customer equipment:', error);
      customerEquipment = [];
      customerIdForEquipment = null;
    }
  }

  function handleBootChoiceChange(event) {
    selectedBootChoice = event.target.value;
    document.getElementById('bootSubmitBtn').disabled = false;
    
    if (selectedBootChoice === 'new') {
      createNewBootForm();
    } else {
      const bootIndex = parseInt(selectedBootChoice.split('-')[1]);
      createExistingBootForm(customerBoots[bootIndex]);
    }
  }

  function createNewBootForm() {
    bootItemsContainer.innerHTML = '';
    
    // Filter only MOUNT service items
    const mountItems = capturedFormData.equipment.filter(item => item.serviceType === 'MOUNT');
    
    mountItems.forEach((item, index) => {
      const bootDiv = document.createElement("div");
      bootDiv.className = "equipment-item-row";
      bootDiv.innerHTML = `
        <h5>${item.skiMake || item.brand} ${item.skiModel || item.model} - New Boot Information</h5>
        
        <div class="mount-field-row">
          <div>
            <label>Binding Brand *</label>
            <input type="text" class="binding-brand" placeholder="e.g., Marker" required data-equipment-index="${index}">
          </div>
          <div>
            <label>Binding Model</label>
            <input type="text" class="binding-model" placeholder="e.g., Griffon 13" data-equipment-index="${index}">
          </div>
        </div>

        <div class="mount-field-row">
          <div>
            <label>Boot Brand *</label>
            <input type="text" class="boot-brand" placeholder="e.g., Salomon" required data-equipment-index="${index}">
          </div>
          <div>
            <label>Boot Model *</label>
            <input type="text" class="boot-model" placeholder="e.g., X-Pro 100" required data-equipment-index="${index}">
          </div>
        </div>

        <div class="mount-field-row single">
          <div>
            <label>BSL (Boot Sole Length in mm) *</label>
            <input type="number" class="bsl" placeholder="e.g., 295" min="250" max="400" required data-ski-index="${index}">
          </div>
        </div>

        <div class="mount-field-row">
          <div>
            <label>Height *</label>
            <div class="height-fields">
              <div>
                <label>Feet</label>
                <select class="height-feet" required data-ski-index="${index}">
                  <option value="">-</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                </select>
              </div>
              <div>
                <label>Inches</label>
                <select class="height-inches" required data-ski-index="${index}">
                  <option value="">-</option>
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                </select>
              </div>
            </div>
          </div>
          <div>
            <label>Weight (lbs) *</label>
            <input type="number" class="weight" placeholder="e.g., 180" min="50" max="400" required data-equipment-index="${index}">
          </div>
        </div>

        <div class="mount-field-row">
          <div>
            <label>Age *</label>
            <input type="number" class="age" placeholder="e.g., 25" min="5" max="120" required data-equipment-index="${index}">
          </div>
          <div>
            <label>Ski Ability Level *</label>
            <select class="ability-level" required data-equipment-index="${index}">
              <option value="">Select Level</option>
              <option value="BEGINNER">Beginner</option>
              <option value="INTERMEDIATE">Intermediate</option>
              <option value="ADVANCED">Advanced</option>
            </select>
          </div>
        </div>
      `;
      bootItemsContainer.appendChild(bootDiv);
    });
  }

  function createExistingBootForm(selectedBoot) {
    bootItemsContainer.innerHTML = '';
    
    // Filter only MOUNT service items
    const mountItems = capturedFormData.equipment.filter(item => item.serviceType === 'MOUNT');
    
    // Convert height back to feet and inches for display
    const heightFeet = Math.floor(selectedBoot.heightInches / 12);
    const heightInches = selectedBoot.heightInches % 12;
    
    mountItems.forEach((item, index) => {
      const bootDiv = document.createElement("div");
      bootDiv.className = "equipment-item-row";
      bootDiv.innerHTML = `
        <h5>${item.skiMake || item.brand} ${item.skiModel || item.model} - Using Existing Boot</h5>
        
        <div class="mount-field-row">
          <div>
            <label>Binding Brand *</label>
            <input type="text" class="binding-brand" placeholder="e.g., Marker" required data-equipment-index="${index}">
          </div>
          <div>
            <label>Binding Model</label>
            <input type="text" class="binding-model" placeholder="e.g., Griffon 13" data-equipment-index="${index}">
          </div>
        </div>

        <div class="mount-field-row">
          <div>
            <label>Boot Brand</label>
            <input type="text" class="boot-brand" value="${selectedBoot.brand}" readonly data-equipment-index="${index}" style="background: #f5f5f5;">
          </div>
          <div>
            <label>Boot Model</label>
            <input type="text" class="boot-model" value="${selectedBoot.model}" readonly data-equipment-index="${index}" style="background: #f5f5f5;">
          </div>
        </div>

        <div class="mount-field-row single">
          <div>
            <label>BSL (Boot Sole Length in mm)</label>
            <input type="number" class="bsl" value="${selectedBoot.bsl}" readonly data-equipment-index="${index}" style="background: #f5f5f5;">
          </div>
        </div>

        <div class="mount-field-row">
          <div>
            <label>Height</label>
            <div class="height-fields">
              <div>
                <label>Feet</label>
                <select class="height-feet" disabled data-equipment-index="${index}" style="background: #f5f5f5;">
                  <option value="${heightFeet}" selected>${heightFeet}</option>
                </select>
              </div>
              <div>
                <label>Inches</label>
                <select class="height-inches" disabled data-equipment-index="${index}" style="background: #f5f5f5;">
                  <option value="${heightInches}" selected>${heightInches}</option>
                </select>
              </div>
            </div>
          </div>
          <div>
            <label>Weight (lbs)</label>
            <input type="number" class="weight" value="${selectedBoot.weight}" readonly data-equipment-index="${index}" style="background: #f5f5f5;">
          </div>
        </div>

        <div class="mount-field-row">
          <div>
            <label>Age</label>
            <input type="number" class="age" value="${selectedBoot.age}" readonly data-equipment-index="${index}" style="background: #f5f5f5;">
          </div>
          <div>
            <label>Ski Ability Level</label>
            <select class="ability-level" disabled data-equipment-index="${index}" style="background: #f5f5f5;">
              <option value="${selectedBoot.abilityLevel}" selected>${selectedBoot.abilityLevel}</option>
            </select>
          </div>
        </div>
        
        <input type="hidden" class="boot-id" value="${selectedBoot.id}" data-equipment-index="${index}">
      `;
      bootItemsContainer.appendChild(bootDiv);
    });
  }
  function addEquipmentItem() {
    equipmentItemCounter++;
    const equipmentDiv = document.createElement("div");
    equipmentDiv.className = "equipment-item-row";
    equipmentDiv.setAttribute("data-equipment-id", equipmentItemCounter);

    equipmentDiv.innerHTML = `
      <button type="button" class="remove-equipment-btn" onclick="removeEquipmentItem(this)" title="Remove Equipment">✕</button>
      <h5>New Equipment Item ${equipmentItemCounter}</h5>
      
      <div class="new-equipment-fields">
        <div class="basic-equipment-fields">
          <div>
            <label>Make *</label>
            <select class="equipment-make" required>
              <option value="">Select Make</option>
            </select>
          </div>
          <div>
            <label>Model *</label>
            <select class="equipment-model" required>
              <option value="">Select Model</option>
            </select>
          </div>
          <div>
            <label>Service *</label>
            <select class="service-type-select" required>
              <option value="">Select Service</option>
              <option value="TUNE">Tune</option>
              <option value="MOUNT">Mount</option>
              <option value="REPAIR">Repair</option>
            </select>
          </div>
          <div>
            <label>Condition *</label>
            <select class="condition" required>
              <option value="">Select Condition</option>
              <option value="NEW">New</option>
              <option value="USED">Used</option>
            </select>
          </div>
        </div>

        <div class="mount-fields">
          <h6>Mount-Specific Information</h6>
          
          <div class="mount-field-row">
            <div>
              <label>Binding Brand *</label>
              <input type="text" class="binding-brand" placeholder="e.g., Marker">
            </div>
            <div>
              <label>Binding Model</label>
              <input type="text" class="binding-model" placeholder="e.g., Griffon 13">
            </div>
          </div>

          <div class="mount-field-row">
            <div>
              <label>Boot Brand *</label>
              <input type="text" class="boot-brand" placeholder="e.g., Salomon">
            </div>
            <div>
              <label>Boot Model *</label>
              <input type="text" class="boot-model" placeholder="e.g., X-Pro 100">
            </div>
          </div>

          <div class="mount-field-row single">
            <div>
              <label>BSL (Boot Sole Length in mm) *</label>
              <input type="number" class="bsl" placeholder="e.g., 295" min="250" max="400">
            </div>
          </div>

          <div class="mount-field-row">
            <div>
              <label>Height *</label>
              <div class="height-fields">
                <div>
                  <label>Feet</label>
                  <select class="height-feet">
                    <option value="">-</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                  </select>
                </div>
                <div>
                  <label>Inches</label>
                  <select class="height-inches">
                    <option value="">-</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                  </select>
                </div>
              </div>
            </div>
            <div>
              <label>Weight (lbs) *</label>
              <input type="number" class="weight" placeholder="e.g., 180" min="50" max="400" required>
            </div>
          </div>

          <div class="mount-field-row">
            <div>
              <label>Age *</label>
              <input type="number" class="age" placeholder="e.g., 25" min="5" max="120" required>
            </div>
            <div>
              <label>Ski Ability Level *</label>
              <select class="ability-level" required>
                <option value="">Select Level</option>
                <option value="BEGINNER">Beginner</option>
                <option value="INTERMEDIATE">Intermediate</option>
                <option value="ADVANCED">Advanced</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    `;

    createEquipmentItemsContainer.appendChild(equipmentDiv);

    // Populate brand dropdown, then wire dependent models dropdown
    const makeSelect = equipmentDiv.querySelector(".equipment-make");
    const modelSelect = equipmentDiv.querySelector(".equipment-model");

    populateBrandSelect(makeSelect).then(() => {
      makeSelect.addEventListener("change", async () => {
        const brandId = makeSelect.value;
        await populateModelSelect(modelSelect, brandId);
      });
    });
    
    // Update button text when new equipment is added
    updateSubmitButtonText();
  }

  async function loadAndDisplayEquipment(equipmentDiv, email, phone) {
    // Lookup equipment if we haven't already
    if (customerEquipment.length === 0 && !customerIdForEquipment) {
      await lookupCustomerEquipment(email, phone);
    }
    
    const equipmentSection = equipmentDiv.querySelector('.equipment-selection-section');
    const existingEquipmentOptions = equipmentDiv.querySelector('.existing-equipment-options');
    
    if (customerEquipment && customerEquipment.length > 0) {
      // Display equipment selection
      existingEquipmentOptions.innerHTML = '';
      
      customerEquipment.forEach((equipment, index) => {
        const equipmentLabel = document.createElement('div');
        equipmentLabel.style.marginBottom = '10px';
        equipmentLabel.innerHTML = `
          <label style="display: block; padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            <input type="radio" name="equipmentChoice-${equipmentDiv.getAttribute('data-equipment-id')}" value="existing-${equipment.id}" class="equipment-choice-radio" style="margin-right: 10px;">
            <strong>${equipment.brand} ${equipment.model}</strong>
            ${equipment.length ? ` - ${equipment.length}cm` : ''} - ${equipment.condition}<br>
            <small style="color: #666;">Type: ${equipment.type} | Level: ${equipment.abilityLevel}</small>
          </label>
        `;
        existingEquipmentOptions.appendChild(equipmentLabel);
      });
      
      equipmentSection.style.display = 'block';
      
      // Add event listeners for new equipment radio choices
      equipmentDiv.querySelectorAll('.equipment-choice-radio').forEach(radio => {
        radio.addEventListener('change', (e) => handleEquipmentChoiceChange(e, equipmentDiv));
      });
    } else {
      // No equipment found - show new equipment fields directly
      equipmentSelection.style.display = 'none';
      equipmentDiv.querySelector('.new-equipment-fields').style.display = 'block';
    }
  }

  function handleEquipmentChoiceChange(event, equipmentDiv) {
    const selectedValue = event.target.value;
    const newEquipmentFields = equipmentDiv.querySelector('.new-equipment-fields');
    
    if (selectedValue === 'new') {
      // Show new equipment fields
      newEquipmentFields.style.display = 'block';
    } else {
      // Hide new equipment fields (existing equipment selected)
      newEquipmentFields.style.display = 'none';
    }
  }

  function removeEquipmentItem(button) {
    const equipmentItem = button.closest('.equipment-item-row');
    equipmentItem.remove();
    checkEquipmentItemCount();
    updateSubmitButtonText(); // Update button text when equipment items change
  }

  function toggleMountFields(serviceSelect) {
    const equipmentItem = serviceSelect.closest('.equipment-item-row');
    const mountFields = equipmentItem.querySelector('.mount-fields');
    
    // For MOUNT service type in the first modal, hide the mount fields
    // Boot requirements will be captured in the second modal
    if (serviceSelect.value === 'MOUNT') {
      mountFields.classList.remove('show');
      setMountFieldsRequired(equipmentItem, false);
      clearMountFields(equipmentItem);
    } else {
      mountFields.classList.remove('show');
      setMountFieldsRequired(equipmentItem, false);
      clearMountFields(equipmentItem);
    }
  }

  function setMountFieldsRequired(equipmentItem, required) {
    const requiredFields = [
      '.binding-brand',
      '.boot-brand',
      '.boot-model',
      '.bsl',
      '.height-feet',
      '.height-inches',
      '.weight',
      '.age',
      '.ability-level'
    ];

    requiredFields.forEach(selector => {
      const field = equipmentItem.querySelector(selector);
      if (field) {
        if (required) {
          field.setAttribute('required', '');
        } else {
          field.removeAttribute('required');
        }
      }
    });
  }

  function clearMountFields(equipmentItem) {
    const fields = [
      '.binding-brand',
      '.binding-model',
      '.boot-brand',
      '.boot-model',
      '.bsl',
      '.height-feet',
      '.height-inches',
      '.weight',
      '.age',
      '.ability-level'
    ];

    fields.forEach(selector => {
      const field = equipmentItem.querySelector(selector);
      if (field) {
        field.value = '';
      }
    });
  }

  function checkEquipmentItemCount() {
    // Allow empty equipment container - user can add items with "+ Add Equipment" button
    updateSubmitButtonText();
  }

  /* ===============================
     Create Work Order Form Submission (First Modal)
     =============================== */
  document.getElementById("createWorkOrderForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    ValidationUtils.clearMessage('createFormMessage');

    // Capture form data for both modals
    const formData = captureCreateFormData();
    if (!formData) return; // Validation failed

    // Check if any ski has MOUNT service type
    if (hasMountService()) {
      // Store data and proceed to boot modal
      capturedFormData = formData;
      createModal.style.display = "none";
      openBootModal();
    } else {
      // Submit directly (no MOUNT services)
      await submitWorkOrder(formData);
    }
  });

  /* ===============================
     Boot Requirements Form Submission (Second Modal)
     =============================== */
  document.getElementById("bootRequirementsForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    ValidationUtils.clearMessage('bootFormMessage');

    // Validate captured form data exists
    if (!capturedFormData) {
      ValidationUtils.showMessage('bootFormMessage', 'No work order data found. Please start over from the first modal.', true);
      return;
    }

    // Validate boot selection was made
    if (!selectedBootChoice) {
      ValidationUtils.showMessage('bootFormMessage', 'Please select a boot option above.', true);
      return;
    }

    // Validate that boot form is populated
    const bootFormItems = bootItemsContainer.children;
    if (bootFormItems.length === 0) {
      ValidationUtils.showMessage('bootFormMessage', 'No boot information forms found. Please try again.', true);
      return;
    }

    // Capture and validate boot requirements
    const bootData = captureBootRequirements();
    if (!bootData) return; // Validation failed - error already shown

    // Validate boot data has items for all MOUNT services
    const mountSkiCount = capturedFormData.equipment.filter(equip => equip.serviceType === 'MOUNT').length;
    if (bootData.length !== mountSkiCount) {
      ValidationUtils.showMessage('bootFormMessage', 'Boot information count does not match mount service count. Please refresh and try again.', true);
      return;
    }

    // Show loading state
    const submitBtn = document.getElementById('bootSubmitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating Work Order...';

    try {
      // Merge boot data with captured ski data
      const completeFormData = mergeBootDataWithSkis(capturedFormData, bootData);
      
      // Submit the complete work order
      await submitWorkOrder(completeFormData);
    } catch (error) {
      // Reset button state on error
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      throw error; // Re-throw to be handled by submitWorkOrder
    }
  });

  /* ===============================
     Form Data Capture and Processing Functions
     =============================== */
  function captureCreateFormData() {
    // Validate customer is selected
    if (!selectedCustomer) {
      ValidationUtils.showMessage('createFormMessage', 'Please select or create a customer first.', true);
      return null;
    }

    // Use selected customer data
    const firstName = selectedCustomer.firstName;
    const lastName = selectedCustomer.lastName;
    const phone = selectedCustomer.phone;
    const email = selectedCustomer.email;

    // Collect selected existing equipment items
    const existingEquipmentItems = collectSelectedExistingEquipment();
    if (existingEquipmentItems === null) {
      // Validation error already shown
      return null;
    }

    // Get new equipment data
    const equipmentItems = [...createEquipmentItemsContainer.children];

    // Validate at least one equipment item (existing or new)
    if (existingEquipmentItems.length === 0 && equipmentItems.length === 0) {
      ValidationUtils.showMessage('createFormMessage', 'At least one equipment item is required.', true);
      return null;
    }

    // Validate equipment data and build payload
    const skis = [...existingEquipmentItems]; // Start with existing equipment
    let hasValidationError = false;

    for (let equipmentItem of equipmentItems) {
      const serviceSelect = equipmentItem.querySelector(".service-type-select");
      const serviceType = serviceSelect.value;
      
      if (!serviceType) {
        ValidationUtils.showMessage('createFormMessage', 'Please select a service type.', true);
        hasValidationError = true;
        break;
      }

      // All items in this section are new equipment
      const makeSelect = equipmentItem.querySelector(".equipment-make");
      const modelSelect = equipmentItem.querySelector(".equipment-model");
      const conditionSelect = equipmentItem.querySelector(".condition");

      const make = makeSelect.options[makeSelect.selectedIndex]?.text || "";
      const model = (modelSelect.value || "").trim();
      const condition = conditionSelect.value;

      if (!make || !model || !condition) {
        ValidationUtils.showMessage('createFormMessage', 'Please complete all equipment information for new equipment.', true);
        hasValidationError = true;
        break;
      }

      // Build equipment data with newEquipment object
      skis.push({
        serviceType: serviceType,
        newEquipment: {
          brand: make,
          model: model,
          condition: condition
        }
      });
    }

    if (hasValidationError) {
      return null;
    }

    // Validate at least one equipment item is included
    if (skis.length === 0) {
      ValidationUtils.showMessage('createFormMessage', 'At least one equipment item is required.', true);
      return null;
    }

    // Get promisedBy date value
    const promisedBy = document.getElementById("createPromisedBy").value;
    
    // Validate promisedBy is provided
    if (!promisedBy) {
      ValidationUtils.showMessage('createFormMessage', 'Promised by date is required.', true);
      return null;
    }

    return {
      customerFirstName: firstName,
      customerLastName: lastName,
      phone: phone,
      email: email,
      equipment: skis,
      promisedBy: promisedBy
    };
  }

  /**
   * Collects selected existing equipment items with their service types
   * Returns array of equipment objects or null if validation fails
   */
  function collectSelectedExistingEquipment() {
    const existingEquipmentList = document.getElementById('existingEquipmentList');
    if (!existingEquipmentList) {
      return [];
    }

    const selectedEquipment = [];
    const checkboxes = existingEquipmentList.querySelectorAll('.existing-equipment-checkbox');
    
    for (let checkbox of checkboxes) {
      if (checkbox.checked) {
        const equipmentId = checkbox.id.replace('existingEquip-', '');
        const serviceSelect = document.getElementById(`service-${equipmentId}`);
        const serviceType = serviceSelect.value;
        
        // Validate service type is selected
        if (!serviceType) {
          ValidationUtils.showMessage('createFormMessage', `Please select a service type for the selected equipment.`, true);
          // Highlight the service dropdown
          serviceSelect.style.border = '2px solid #dc2626';
          serviceSelect.focus();
          return null;
        }
        
        // Add to selected equipment array
        selectedEquipment.push({
          equipmentId: parseInt(equipmentId),
          serviceType: serviceType
        });
      }
    }
    
    return selectedEquipment;
  }

  function captureBootRequirements() {
    const bootItems = [...bootItemsContainer.children];
    const bootRequirements = [];

    for (let bootItem of bootItems) {
      const bindingBrand = bootItem.querySelector('.binding-brand').value.trim();
      const bindingModel = bootItem.querySelector('.binding-model').value.trim();
      const equipmentIndex = parseInt(bootItem.querySelector('.binding-brand').getAttribute('data-equipment-index'));

      // Check if using existing boot or creating new one
      const bootIdField = bootItem.querySelector('.boot-id');
      
      let bootData;
      
      if (bootIdField && selectedBootChoice.startsWith('existing-')) {
        // Using existing boot - only need binding info
        if (!bindingBrand) {
          ValidationUtils.showMessage('bootFormMessage', 'Please complete binding brand information.', true);
          return null;
        }
        
        const existingBootIndex = parseInt(selectedBootChoice.split('-')[1]);
        const existingBoot = customerBoots[existingBootIndex];
        
        bootData = {
          equipmentIndex: equipmentIndex,
          bindingBrand: bindingBrand,
          bindingModel: bindingModel || null,
          bootId: existingBoot.id, // Link to existing boot
          // Include existing boot data for completeness but API will use bootId
          bootBrand: existingBoot.brand,
          bootModel: existingBoot.model,
          bsl: existingBoot.bsl,
          heightInches: existingBoot.heightInches,
          weight: existingBoot.weight,
          age: existingBoot.age,
          abilityLevel: existingBoot.abilityLevel // Ensure proper field name
        };
      } else {
        // Creating new boot - need all boot info
        const bootBrand = bootItem.querySelector('.boot-brand').value.trim();
        const bootModel = bootItem.querySelector('.boot-model').value.trim();
        const bsl = bootItem.querySelector('.bsl').value;
        const heightFeet = bootItem.querySelector('.height-feet').value;
        const heightInches = bootItem.querySelector('.height-inches').value;
        const weight = bootItem.querySelector('.weight').value;
        const age = bootItem.querySelector('.age').value;
        const abilityLevel = bootItem.querySelector('.ability-level').value;

        // Validate required boot fields
        if (!bindingBrand || !bootBrand || !bootModel || !bsl || 
            heightFeet === '' || heightInches === '' || !weight || !age || !abilityLevel) {
          ValidationUtils.showMessage('bootFormMessage', 'Please complete all required boot information.', true);
          return null;
        }

        // Convert height to total inches
        const totalInches = (parseInt(heightFeet) * 12) + parseInt(heightInches);

        // Validate numeric ranges
        const bslValue = parseInt(bsl);
        const weightValue = parseInt(weight);
        const ageValue = parseInt(age);
        
        if (bslValue < 250 || bslValue > 400) {
          ValidationUtils.showMessage('bootFormMessage', 'BSL must be between 250-400mm.', true);
          return null;
        }
        
        if (weightValue < 50 || weightValue > 400) {
          ValidationUtils.showMessage('bootFormMessage', 'Weight must be between 50-400 lbs.', true);
          return null;
        }
        
        if (ageValue < 5 || ageValue > 120) {
          ValidationUtils.showMessage('bootFormMessage', 'Age must be between 5-120 years.', true);
          return null;
        }

        bootData = {
          equipmentIndex: equipmentIndex,
          bindingBrand: bindingBrand,
          bindingModel: bindingModel || null,
          bootBrand: bootBrand,
          bootModel: bootModel,
          bsl: bslValue,
          heightInches: totalInches,
          weight: weightValue,
          age: ageValue,
          abilityLevel: abilityLevel, // Field name corrected for backend compatibility
          isNewBoot: true // Flag to indicate this is a new boot
        };
      }

      bootRequirements.push(bootData);
    }

    return bootRequirements;
  }

  function mergeBootDataWithSkis(formData, bootRequirements) {
    const mergedData = { ...formData };
    let mountItemIndex = 0;

    // Add boot data to corresponding MOUNT service equipment
    mergedData.equipment = formData.equipment.map(equip => {
      if (equip.serviceType === 'MOUNT') {
        const bootData = bootRequirements[mountItemIndex];
        mountItemIndex++;
        
        // Create clean equipment item with boot data
        const equipWithBootData = {
          serviceType: equip.serviceType,
          bindingBrand: bootData.bindingBrand,
          bindingModel: bootData.bindingModel
        };
        
        // Preserve equipment selection (existing vs. new)
        if (equip.equipmentId) {
          // Using existing equipment
          equipWithBootData.equipmentId = equip.equipmentId;
        } else if (equip.newEquipment) {
          // Creating new equipment
          equipWithBootData.newEquipment = equip.newEquipment;
        }
        
        // Add boot information based on whether it's existing or new
        if (bootData.bootId) {
          // Existing boot - include bootId for linking
          equipWithBootData.bootId = bootData.bootId;
        } else {
          // New boot - include all boot creation fields
          equipWithBootData.bootBrand = bootData.bootBrand;
          equipWithBootData.bootModel = bootData.bootModel;
          equipWithBootData.bsl = bootData.bsl;
          equipWithBootData.heightInches = bootData.heightInches;
          equipWithBootData.weight = bootData.weight;
          equipWithBootData.age = bootData.age;
          equipWithBootData.skiAbilityLevel = bootData.abilityLevel;
        }
        
        return equipWithBootData;
      }
      // Non-MOUNT services - return as-is (preserving equipmentId or newEquipment)
      return equip;
    });

    // Return clean payload structure for WorkOrderRequest
    return {
      customerFirstName: mergedData.customerFirstName,
      customerLastName: mergedData.customerLastName,
      phone: mergedData.phone,
      email: mergedData.email,
      promisedBy: mergedData.promisedBy,
      equipment: mergedData.equipment
    };
  }

  async function submitWorkOrder(payload) {
    try {
      // Final validation before submission
      if (!payload.customerFirstName || !payload.customerLastName || !payload.phone || !payload.email) {
        throw new Error('Missing required customer information');
      }
      
      if (!payload.equipment || payload.equipment.length === 0) {
        throw new Error('At least one equipment item is required');
      }
      
      // Validate each equipment item has required fields
      for (const equip of payload.equipment) {
        if (!equip.serviceType) {
          throw new Error('Missing service type');
        }
        
        // Validate equipment data (either equipmentId or newEquipment must be present)
        if (!equip.equipmentId && !equip.newEquipment) {
          throw new Error('Missing equipment information (either equipmentId or newEquipment required)');
        }
        
        // If newEquipment is provided, validate its required fields
        if (equip.newEquipment) {
          if (!equip.newEquipment.brand || !equip.newEquipment.model || !equip.newEquipment.condition) {
            throw new Error('Missing required new equipment information (brand, model, condition)');
          }
        }
        
        // For MOUNT services, ensure boot/binding information is present
        if (equip.serviceType === 'MOUNT') {
          if (!equip.bindingBrand) {
            throw new Error('Binding brand is required for mount services');
          }
          
          // Either bootId (existing boot) OR all boot creation fields must be present
          if (!equip.bootId) {
            const requiredBootFields = ['bootBrand', 'bootModel', 'bsl', 'heightInches', 'weight', 'age', 'skiAbilityLevel'];
            for (const field of requiredBootFields) {
              if (equip[field] === undefined || equip[field] === null || equip[field] === '') {
                throw new Error(`${field} is required for new boot creation`);
              }
            }
          }
        }
      }
      
      // Log payload for debugging (remove in production)
      console.log('Submitting work order payload:', JSON.stringify(payload, null, 2));
      
      const response = await APIUtils.authenticatedFetch(API_CONFIG.WORKORDERS, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('API Error Response:', errorText);
        throw new Error(`Failed to create work order: ${response.status} ${response.statusText}`);
      }
      
      const result = await response.json();
      console.log('Work order created successfully:', result);

      // Save initial note if provided
      const initialNoteText = document.getElementById('createWorkOrderNoteText')?.value.trim();
      if (initialNoteText && result.id) {
        try {
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          const createdBy = user.username || 'Staff';
          
          await APIUtils.authenticatedFetch(`/api/workorders/${result.id}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              noteText: initialNoteText,
              createdBy: createdBy
            })
          });
        } catch (noteError) {
          console.error('Failed to save initial note:', noteError);
          // Don't fail the whole operation if note save fails
        }
      }

      // Success - close all modals and refresh
      closeCreateModal();
      closeBootModal();
      
      // Reset button states
      const bootSubmitBtn = document.getElementById('bootSubmitBtn');
      if (bootSubmitBtn) {
        bootSubmitBtn.disabled = true; // Will be re-enabled when boot choice is made
        bootSubmitBtn.textContent = 'Create Work Order';
      }
      
      refreshCurrentTab();
      ValidationUtils.showMessage('listMessage', 'Work order created successfully!', false);

    } catch (error) {
      console.error("Error creating work order:", error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        const currentModal = bootModal.style.display === 'block' ? 'bootFormMessage' : 'createFormMessage';
        const errorMessage = error.message.includes('Failed to create work order') 
          ? 'Error creating work order. Please check your information and try again.' 
          : error.message;
        ValidationUtils.showMessage(currentModal, errorMessage, true);
      }
    }
  }

  /* ===============================
     Fetch Work Orders (Updated for Tabs)
     =============================== */
  async function fetchWorkOrdersByStatus(status) {
    if (!AuthUtils.isAuthenticated()) {
      showLoginView();
      return;
    }

    try {
      let url = API_CONFIG.WORKORDERS;
      
      // Add status filter parameter for the specific tab
      if (status) {
        url += `?status=${encodeURIComponent(status)}`;
      }
      
      // Debug: Log the URL being called
      console.log('Fetching work orders with URL:', url);
      console.log('Status parameter:', status);

      const response = await APIUtils.authenticatedFetch(url);
      let data = await response.json();

      // Special handling for READY_FOR_PICKUP: only show orders where ALL items are DONE
      if (status === 'READY_FOR_PICKUP') {
        data = data.filter(order => {
          const equipment = order.equipment || [];
          if (equipment.length === 0) return false;
          return equipment.every(item => item.status === 'DONE');
        });
      }

      tableBody.innerHTML = "";
      ValidationUtils.clearMessage('listMessage');

      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="9">
          <div class="empty-state">
            <i class="fas fa-clipboard-list"></i>
            <h3>No work orders found</h3>
            <p>No work orders match the current filter. Try switching to a different tab or create a new work order.</p>
          </div>
        </td></tr>`;
        return;
      }

      data.forEach(order => {
        const row = document.createElement("tr");

        // Count equipment by status
        const equipment = order.equipment || [];
        const doneCount = equipment.filter(equip => equip.status === "DONE").length;
        const totalCount = equipment.length;

        const equipmentSummary = equipment.length > 0 
          ? `${equipment.map(equip => `${equip.brand} ${equip.model} <span style="font-weight: 700; color: #3b82f6;">(${equip.serviceType})</span> ${getModernStatusBadge(equip.status)}`).join("<br>")}`
          : "No equipment";

        row.innerHTML = `
          <td>${order.id}</td>
          <td><strong>${order.customerName || ""}</strong></td>
          <td>${order.customerPhone || ""}</td>
          <td>${order.customerEmail || ""}</td>
          <td>${equipmentSummary}</td>
          <td>${getModernStatusBadge(order.status)}<br><small style="color: #64748b;">${doneCount}/${totalCount} items done</small></td>
          <td style="color: ${order.promisedBy ? '#059669' : '#6b7280'}; font-weight: ${order.promisedBy ? '600' : 'normal'};">${order.promisedBy ? formatDate(order.promisedBy) : "Not Set"}</td>
          <td>${formatDate(order.createdAt) || ""}</td>
          <td class="action-buttons">
            <button type="button" class="action-btn btn-edit" onclick="openEditModal(${order.id})">
              <i class="fas fa-edit"></i> Manage
            </button>
          </td>
        `;

        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error("Error fetching work orders:", error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        ValidationUtils.showMessage('listMessage', 'Failed to load work orders.', true);
      }
    }
  }

  // Legacy function name for compatibility - just calls the new function
  function fetchWorkOrders() {
    fetchWorkOrdersByStatus(currentActiveTab);
  }

  /* ===============================
     Fetch Work Orders by Service Type
     Shows work orders that contain at least one item of the specified service type
     Only shows orders with RECEIVED, IN_PROGRESS, or READY_FOR_PICKUP status
     =============================== */
  async function fetchWorkOrdersByServiceType(serviceType) {
    if (!AuthUtils.isAuthenticated()) {
      showLoginView();
      return;
    }

    try {
      // Fetch all work orders (no status filter)
      const response = await APIUtils.authenticatedFetch(API_CONFIG.WORKORDERS);
      const allOrders = await response.json();

      // Filter work orders that:
      // 1. Have at least one equipment item with the specified service type
      // 2. Have status RECEIVED, IN_PROGRESS, or READY_FOR_PICKUP
      const filteredOrders = allOrders.filter(order => {
        const equipment = order.equipment || [];
        const hasServiceType = equipment.some(item => item.serviceType === serviceType);
        const isRelevantStatus = order.status === 'RECEIVED' || order.status === 'IN_PROGRESS' || order.status === 'READY_FOR_PICKUP';
        return hasServiceType && isRelevantStatus;
      });

      tableBody.innerHTML = "";
      ValidationUtils.clearMessage('listMessage');

      if (filteredOrders.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="9">
          <div class="empty-state">
            <i class="fas fa-clipboard-list"></i>
            <h3>No ${serviceType} work orders found</h3>
            <p>No work orders contain ${serviceType} service items. Try switching to a different tab or create a new work order.</p>
          </div>
        </td></tr>`;
        return;
      }

      // Sort by due date (promisedBy) first, then creation date (oldest first)
      filteredOrders.sort((a, b) => {
        // Handle null promisedBy values - put them at the end
        if (!a.promisedBy && !b.promisedBy) {
          return new Date(a.createdAt) - new Date(b.createdAt);
        }
        if (!a.promisedBy) return 1; // a goes after b
        if (!b.promisedBy) return -1; // a goes before b
        
        // Both have promisedBy dates, sort by them
        const promisedDiff = new Date(a.promisedBy) - new Date(b.promisedBy);
        if (promisedDiff !== 0) return promisedDiff;
        
        // Same promisedBy date, sort by createdAt
        return new Date(a.createdAt) - new Date(b.createdAt);
      });

      filteredOrders.forEach(order => {
        const row = document.createElement("tr");

        // Filter equipment to only show items matching this service type
        const allEquipment = order.equipment || [];
        const equipment = allEquipment.filter(item => item.serviceType === serviceType);
        
        // Count done items for this service type only
        const doneCount = equipment.filter(equip => equip.status === "DONE").length;
        const totalCount = equipment.length;

        const equipmentSummary = equipment.length > 0 
          ? `${equipment.map(equip => `${equip.brand} ${equip.model} <span style="font-weight: 700; color: #3b82f6;">(${equip.serviceType})</span> ${getModernStatusBadge(equip.status)}`).join("<br>")}`
          : "No equipment";

        row.innerHTML = `
          <td>${order.id}</td>
          <td><strong>${order.customerName || ""}</strong></td>
          <td>${order.customerPhone || ""}</td>
          <td>${order.customerEmail || ""}</td>
          <td>${equipmentSummary}</td>
          <td>${getModernStatusBadge(order.status)}<br><small style="color: #64748b;">${doneCount}/${totalCount} items done</small></td>
          <td style="color: ${order.promisedBy ? '#059669' : '#6b7280'}; font-weight: ${order.promisedBy ? '600' : 'normal'};">${order.promisedBy ? formatDate(order.promisedBy) : "Not Set"}</td>
          <td>${formatDate(order.createdAt) || ""}</td>
          <td class="action-buttons">
            <button type="button" class="action-btn btn-edit" onclick="openEditModal(${order.id})">
              <i class="fas fa-edit"></i> Manage
            </button>
          </td>
        `;

        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error("Error fetching work orders by service type:", error);
      if (error.message === "Authentication required") {
        showLoginView();
      } else {
        ValidationUtils.showMessage('listMessage', 'Failed to load work orders.', true);
      }
    }
  }

  /* ===============================
     Initialize Page
     =============================== */
  // Check if user is already authenticated on page load
  window.addEventListener('DOMContentLoaded', function() {
    if (AuthUtils.isAuthenticated()) {
      // Try to show authenticated view and fetch data for default tab
      showAuthenticatedView();
      fetchWorkOrdersByStatus(currentActiveTab); // Load default "RECEIVED" tab
    } else {
      showLoginView();
    }

    // Handle Enter key in login fields
    document.getElementById("loginEmail").addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });

    document.getElementById("loginPassword").addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });
  });

</script>

</body>
</html>